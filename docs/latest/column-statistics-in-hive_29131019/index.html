<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : Column Statistics in Hive</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu style=background:#000;margin:0>
<nav class="navbar navbar-expand-lg navbar-dark bg-black">
<div class=container-fluid>
<a href=https://hive.apache.org> <img src=https://hive.apache.org/images/hive.svg width=60 height=35 alt="Apache Software Foundation"></a>
<a class="header-text navbar-brand" href=https://hive.apache.org>Apache Hive</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item dropdown">
<a class=nav-link href=/general/downloads id=navbarDropdown role=button aria-expanded=false>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/LanguageManual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/DesignDocs>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HiveDeveloperFAQ>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Hive+PreCommit+Patch+Testing>Precommit Patch Testing</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToContribute>How To Contribute</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Home#Home-ResourcesforContributors>Resources for Contributors</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li>
<hr class=dropdown-divider>
</li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToRelease>How To Release</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class=nav-link href=https://hive.blog.apache.org/ id=navbarDropdown role=button aria-expanded=false>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
<li>
<form action=/search method=get class=search-bar>
<input type=search name=q id=search-query placeholder=Search... class=search-input>
<button type=submit class=search-button>Search</button>
</form>
</li>
</ul>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs>
<h1 id=apache-hive--column-statistics-in-hive>Apache Hive : Column Statistics in Hive</h1>
<p>*** <a href=#introduction>Introduction</a></p>
<ul>
<li><a href=#hiveql-changes>HiveQL changes</a></li>
<li><a href=#metastore-schema>Metastore Schema</a></li>
<li><a href=#metastore-thrift-api>Metastore Thrift API</a>**</li>
</ul>
<h3 id=introduction><strong>Introduction</strong></h3>
<p>This document describes changes to a) HiveQL, b) metastore schema, and c) metastore Thrift API to support column level statistics in Hive. Please note that the document doesn’t describe the changes needed to persist histograms in the metastore yet.</p>
<p>Version information</p>
<p>Column statistics are introduced in Hive 0.10.0 by <a href=https://issues.apache.org/jira/browse/HIVE-1362>HIVE-1362</a>. This is the design document.</p>
<p>Column statistics auto gather is introduced in Hive 2.3 by <a href=https://issues.apache.org/jira/browse/HIVE-11160>HIVE-11160</a>. This is also the design document.</p>
<p>For general information about Hive statistics, see <a href=https://hive.apache.org/docs/latest/statsdev_27362062/>Statistics in Hive</a>. For information about top K statistics, see <a href=https://hive.apache.org/docs/latest/top-k-stats_30150275/>Column Level Top K Statistics</a>.</p>
<h3 id=hiveql-changes><strong>HiveQL changes</strong></h3>
<p>HiveQL currently supports the <a href=#analyze-command>analyze command</a> to compute statistics on tables and partitions. HiveQL’s analyze command will be extended to trigger statistics computation on one or more column in a Hive table/partition. The necessary changes to HiveQL are as below,</p>
<p><code>analyze table t [partition p] compute statistics for [columns c,...];</code></p>
<p>Please note that table and column aliases are not supported in the analyze statement.</p>
<p>To view column stats :</p>
<pre tabindex=0><code>describe formatted [table_name] [column_name];
</code></pre><h3 id=metastore-schema><strong>Metastore Schema</strong></h3>
<p>To persist column level statistics, we propose to add the following new tables,</p>
<p>CREATE TABLE TAB_COL_STATS<br>
(<br>
CS_ID NUMBER NOT NULL,<br>
TBL_ID NUMBER NOT NULL,<br>
COLUMN_NAME VARCHAR(128) NOT NULL,<br>
COLUMN_TYPE VARCHAR(128) NOT NULL,<br>
TABLE_NAME VARCHAR(128) NOT NULL,<br>
DB_NAME VARCHAR(128) NOT NULL,</p>
<p>LOW_VALUE RAW,<br>
HIGH_VALUE RAW,<br>
NUM_NULLS BIGINT,<br>
NUM_DISTINCTS BIGINT,</p>
<p>BIT_VECTOR, BLOB,  /* introduced in <a href=https://issues.apache.org/jira/browse/HIVE-16997>HIVE-16997</a> in Hive 3.0.0 */</p>
<p>AVG_COL_LEN DOUBLE,<br>
MAX_COL_LEN BIGINT,<br>
NUM_TRUES BIGINT,<br>
NUM_FALSES BIGINT,<br>
LAST_ANALYZED BIGINT NOT NULL)</p>
<p>ALTER TABLE COLUMN_STATISTICS ADD CONSTRAINT COLUMN_STATISTICS_PK PRIMARY KEY (CS_ID);</p>
<p>ALTER TABLE COLUMN_STATISTICS ADD CONSTRAINT COLUMN_STATISTICS_FK1 FOREIGN KEY (TBL_ID) REFERENCES TBLS (TBL_ID) INITIALLY DEFERRED ;</p>
<p>CREATE TABLE PART_COL_STATS<br>
(<br>
CS_ID NUMBER NOT NULL,<br>
PART_ID NUMBER NOT NULL,</p>
<p>DB_NAME VARCHAR(128) NOT NULL,<br>
COLUMN_NAME VARCHAR(128) NOT NULL,<br>
COLUMN_TYPE VARCHAR(128) NOT NULL,<br>
TABLE_NAME VARCHAR(128) NOT NULL,<br>
PART_NAME VARCHAR(128) NOT NULL,</p>
<p>LOW_VALUE RAW,<br>
HIGH_VALUE RAW,<br>
NUM_NULLS BIGINT,<br>
NUM_DISTINCTS BIGINT,</p>
<p>BIT_VECTOR, BLOB,  /* introduced in <a href=https://issues.apache.org/jira/browse/HIVE-16997>HIVE-16997</a> in Hive 3.0.0 */</p>
<p>AVG_COL_LEN DOUBLE,<br>
MAX_COL_LEN BIGINT,<br>
NUM_TRUES BIGINT,<br>
NUM_FALSES BIGINT,<br>
LAST_ANALYZED BIGINT NOT NULL)</p>
<p>ALTER TABLE COLUMN_STATISTICS ADD CONSTRAINT COLUMN_STATISTICS_PK PRIMARY KEY (CS_ID);</p>
<p>ALTER TABLE COLUMN_STATISTICS ADD CONSTRAINT COLUMN_STATISTICS_FK1 FOREIGN KEY (PART_ID) REFERENCES PARTITIONS (PART_ID) INITIALLY DEFERRED;</p>
<h3 id=metastore-thrift-api><strong>Metastore Thrift API</strong></h3>
<p>We propose to add the following Thrift structs to transport column statistics:</p>
<p>struct BooleanColumnStatsData {<br>
1: required i64 numTrues,<br>
2: required i64 numFalses,<br>
3: required i64 numNulls<br>
}</p>
<p>struct DoubleColumnStatsData {<br>
1: required double lowValue,<br>
2: required double highValue,<br>
3: required i64 numNulls,<br>
4: required i64 numDVs,</p>
<p>5: optional string bitVectors</p>
<p>}</p>
<p>struct LongColumnStatsData {<br>
1: required i64 lowValue,<br>
2: required i64 highValue,<br>
3: required i64 numNulls,<br>
4: required i64 numDVs,</p>
<p>5: optional string bitVectors<br>
}</p>
<p>struct StringColumnStatsData {<br>
1: required i64 maxColLen,<br>
2: required double avgColLen,<br>
3: required i64 numNulls,<br>
4: required i64 numDVs,</p>
<p>5: optional string bitVectors<br>
}</p>
<p>struct BinaryColumnStatsData {<br>
1: required i64 maxColLen,<br>
2: required double avgColLen,<br>
3: required i64 numNulls<br>
}</p>
<p>struct Decimal {<br>
1: required binary unscaled,<br>
3: required i16 scale<br>
}</p>
<p>struct DecimalColumnStatsData {<br>
1: optional Decimal lowValue,<br>
2: optional Decimal highValue,<br>
3: required i64 numNulls,<br>
4: required i64 numDVs,<br>
5: optional string bitVectors<br>
}</p>
<p>struct Date {<br>
1: required i64 daysSinceEpoch<br>
}</p>
<p>struct DateColumnStatsData {<br>
1: optional Date lowValue,<br>
2: optional Date highValue,<br>
3: required i64 numNulls,<br>
4: required i64 numDVs,<br>
5: optional string bitVectors<br>
}</p>
<p>union ColumnStatisticsData {<br>
1: BooleanColumnStatsData booleanStats,<br>
2: LongColumnStatsData longStats,<br>
3: DoubleColumnStatsData doubleStats,<br>
4: StringColumnStatsData stringStats,<br>
5: BinaryColumnStatsData binaryStats,<br>
6: DecimalColumnStatsData decimalStats,<br>
7: DateColumnStatsData dateStats<br>
}</p>
<p>struct ColumnStatisticsObj {<br>
1: required string colName,<br>
2: required string colType,<br>
3: required ColumnStatisticsData statsData<br>
}</p>
<p>struct ColumnStatisticsDesc {<br>
1: required bool isTblLevel,<br>
2: required string dbName,<br>
3: required string tableName,<br>
4: optional string partName,<br>
5: optional i64 lastAnalyzed<br>
}</p>
<p>struct ColumnStatistics {<br>
1: required ColumnStatisticsDesc statsDesc,<br>
2: required list statsObj;<br>
}</p>
<p>We propose to add the following Thrift APIs to persist, retrieve and delete column statistics:</p>
<p>bool update_table_column_statistics(1:ColumnStatistics stats_obj) throws (1:NoSuchObjectException o1,<br>
2:InvalidObjectException o2, 3:MetaException o3, 4:InvalidInputException o4)<br>
bool update_partition_column_statistics(1:ColumnStatistics stats_obj) throws (1:NoSuchObjectException o1,<br>
2:InvalidObjectException o2, 3:MetaException o3, 4:InvalidInputException o4)</p>
<p>ColumnStatistics get_table_column_statistics(1:string db_name, 2:string tbl_name, 3:string col_name) throws<br>
(1:NoSuchObjectException o1, 2:MetaException o2, 3:InvalidInputException o3, 4:InvalidObjectException o4)<br>
ColumnStatistics get_partition_column_statistics(1:string db_name, 2:string tbl_name, 3:string part_name,<br>
4:string col_name) throws (1:NoSuchObjectException o1, 2:MetaException o2,<br>
3:InvalidInputException o3, 4:InvalidObjectException o4)</p>
<p>bool delete_partition_column_statistics(1:string db_name, 2:string tbl_name, 3:string part_name, 4:string col_name) throws<br>
(1:NoSuchObjectException o1, 2:MetaException o2, 3:InvalidObjectException o3,<br>
4:InvalidInputException o4)<br>
bool delete_table_column_statistics(1:string db_name, 2:string tbl_name, 3:string col_name) throws<br>
(1:NoSuchObjectException o1, 2:MetaException o2, 3:InvalidObjectException o3,<br>
4:InvalidInputException o4)</p>
<p>Note that delete_column_statistics is needed to remove the entries from the metastore when a table is dropped. Also note that currently Hive doesn’t support drop column.</p>
<p>Note that in V1 of the project, we will support only scalar statistics. Furthermore, we will support only static partitions, i.e., both the partition key and partition value should be specified in the analyze command. In a following version, we will add support for height balanced histograms as well as support for dynamic partitions in the analyze command for column level statistics.</p>
<h2 id=comments>Comments:</h2>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
<tr>
<td>Shreepadma, is there a jira for this ? Is this ready for review, or is it a initial design ?</td>
</tr>
<tr>
<td>Also, can you go over <a href=https://issues.apache.org/jira/browse/HIVE-3421>https://issues.apache.org/jira/browse/HIVE-3421</a> and see how the two are related ?</td>
</tr>
</tbody>
</table>
<p>Posted by namit.jain at Sep 14, 2012 00:51
|
|
Namit, This patch is ready for review. There is already a JIRA for this - HIVE-1362. I&rsquo;ve the patch on both JIRA and reviewboard. Please note that this goes beyond HIVE-3421 - this patch adds the stats specified on both this wiki and the JIRA page. Thanks.</p>
<p>Posted by shreepadma at Oct 03, 2012 00:46
|</p>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are © 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>