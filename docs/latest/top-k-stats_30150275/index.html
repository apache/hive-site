<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : Top K Stats</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu style=background:#000;margin:0>
<nav class="navbar navbar-expand-lg navbar-dark bg-black">
<div class=container-fluid>
<a href=https://hive.apache.org> <img src=https://hive.apache.org/images/hive.svg width=60 height=35 alt="Apache Software Foundation"></a>
<a class="header-text navbar-brand" href=https://hive.apache.org>Apache Hive</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item dropdown">
<a class=nav-link href=/general/downloads id=navbarDropdown role=button aria-expanded=false>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/LanguageManual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/DesignDocs>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HiveDeveloperFAQ>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Hive+PreCommit+Patch+Testing>Precommit Patch Testing</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToContribute>How To Contribute</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Home#Home-ResourcesforContributors>Resources for Contributors</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li>
<hr class=dropdown-divider>
</li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToRelease>How To Release</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class=nav-link href=https://hive.blog.apache.org/ id=navbarDropdown role=button aria-expanded=false>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
<li>
<form action=/search method=get class=search-bar>
<input type=search name=q id=search-query placeholder=Search... class=search-input>
<button type=submit class=search-button>Search</button>
</form>
</li>
</ul>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs>
<h1 id=apache-hive--top-k-stats>Apache Hive : Top K Stats</h1>
<h1 id=column-level-top-k-statistics>Column Level Top K Statistics</h1>
<ul>
<li><a href=#column-level-top-k-statistics>Column Level Top K Statistics</a>
<ul>
<li><a href=#scope>Scope</a></li>
<li><a href=#implementation>Implementation</a></li>
<li><a href=#usage>Usage</a></li>
<li><a href=#example>Example</a>
<ul>
<li><a href=#newly-created-tables>Newly Created Tables</a></li>
<li><a href=#existing-tables>Existing Tables</a></li>
</ul>
</li>
<li><a href=#current-status-jira>Current Status (JIRA)</a></li>
</ul>
</li>
</ul>
<p>This document is an addition to <a href=https://cwiki.apache.org/confluence/display/Hive/StatsDev>Statistics in Hive</a>. It describes the support of collecting column level top K values for Hive tables (see <a href=https://issues.apache.org/jira/browse/HIVE-3421>HIVE-3421</a>).</p>
<h2 id=scope>Scope</h2>
<p>In addition to the partition statistics, column level top K values can also be estimated for Hive tables.<br>
The name and top K values of the most skewed column is stored in the partition or non-partitioned table’s skewed information, if user did not specify <a href=https://cwiki.apache.org/confluence/display/Hive/ListBucketing>skew</a>. This works for both newly created and existing tables.<br>
The algorithm for computing top K is based on this paper: <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.114.9563&rep=rep1&type=pdf">Efficient Computation of Frequent and Top-k Elements in Data Streams</a>.</p>
<h2 id=implementation>Implementation</h2>
<p>Top K statistics are gathered along with partition level statistics. The interface IStatsAggregator needs to add a method aggregateStatsTopK() that reads multiple entries from the temporary storage:</p>
<pre tabindex=0><code>...

public interface IStatsAggregator {

...

  /**
 * This method aggregates top K statistics.
   *
 * */
  public List&lt;String&gt; aggregateStatsTopK(String keyPrefix, String statType);

...

}

</code></pre><h2 id=usage>Usage</h2>
<p>Top K statistics are disabled by default. The user can set the boolean variable <strong>hive.stats.topk.collect</strong> to be <strong>true</strong> to enable computing top K and putting top K into skewed information.</p>
<pre tabindex=0><code>set hive.stats.topk.collect=true;

</code></pre><p>The user can also specify the number of K by setting the integer variable <strong>hive.stats.topk.num</strong>, and the minimal row percentage that a value needs to hold to be in the top K result, by setting the float variable <strong>hive.stats.topk.minpercent</strong>.</p>
<pre tabindex=0><code>set hive.stats.topk.num=8;
set hive.stats.topk.minpercent=5.0;

</code></pre><p>Another integer variable, <strong>hive.stats.topk.poolsize</strong>, specifies the number of values to be monitored while computing top K. The accuracy of top K estimate increases as this number gets larger.</p>
<pre tabindex=0><code>set hive.stats.topk.poolsize=200;

</code></pre><p>Computing top K for a large number of partitions simultaneously can be stressful to memory. The user can specify the integer variable <strong>hive.stats.topk.maxpartnum</strong> for the maximal number of partitions to collect Top K. When this number is exceeded, top K will be disabled for all the remaining partitions.</p>
<pre tabindex=0><code>set hive.stats.topk.maxpartnum=10;

</code></pre><p>In case of JDBC implementation of temporary stored statistics (eg. Derby or MySQL), the user should also specify the column type for top K, by setting the variable <strong>hive.stats.topk.column.type</strong>. By default, <strong>TEXT</strong> is used for MySQL, and <strong>LONG VARCHAR</strong> is used for Derby.</p>
<pre tabindex=0><code>set hive.stats.topk.column.type=’LONG VARCHAR’;

</code></pre><h2 id=example>Example</h2>
<p>The user may set top K related variables at the beginning:</p>
<pre tabindex=0><code>set hive.stats.topk.collect=true;
set hive.stats.topk.num=4;
set hive.stats.topk.minpercent=0;
set hive.stats.topk.poolsize=100;

</code></pre><h3 id=newly-created-tables>Newly Created Tables</h3>
<p>Suppose a partitioned table is created without skew, and data is inserted to its partitions:</p>
<pre tabindex=0><code>CREATE TABLE table1 (key STRING, value STRING) PARTITIONED BY (ds STRING);
INSERT OVERWRITE TABLE table1 PARTITION (ds='2012-09-07') SELECT * FROM table_src;

</code></pre><p>Top K was computed for the partition while data was inserted. If the user issues the command:</p>
<pre tabindex=0><code>DESCRIBE FORMATTED table1 partition (ds='2012-09-07');

</code></pre><p>then among the output, the following will be displayed:</p>
<pre tabindex=0><code>...
Skewed Columns:         [value]                  
Skewed Values:          [[val_348], [val_230], [val_401], [val_70]]      
...

</code></pre><p>If the user issues the command:</p>
<pre tabindex=0><code>DESCRIBE FORMATTED table1;

</code></pre><p>then among the output, there will not be skewed information, since table level top K is not available for partitioned tables.</p>
<p>For a non-partitioned table:</p>
<pre tabindex=0><code>CREATE TABLE table1 (key STRING, value STRING);
INSERT OVERWRITE TABLE table1 SELECT * FROM table_src;

</code></pre><p>If the user issues the command:</p>
<pre tabindex=0><code>DESCRIBE FORMATTED table1;

</code></pre><p>then among the output, the following will be displayed:</p>
<pre tabindex=0><code>...
Skewed Columns:         [value]                  
Skewed Values:          [[val_348], [val_230], [val_401], [val_70]]      
...

</code></pre><p>When a table is created with skew:</p>
<pre tabindex=0><code>set hive.internal.ddl.list.bucketing.enable=true;
CREATE TABLE table1 (key STRING, value STRING) PARTITIONED BY (ds STRING) SKEWED BY (key) on ('38', '49');
INSERT OVERWRITE TABLE table1 PARTITION (ds='2012-09-07') SELECT * FROM table_src;

</code></pre><p>Top K will not be collected, and the user specified skewed information remains. If the user issues the command:</p>
<pre tabindex=0><code>DESCRIBE FORMATTED table1 partition (ds='2012-09-07');

</code></pre><p>then among the output, the following will be displayed:</p>
<pre tabindex=0><code>...
Skewed Columns:         [key]                    
Skewed Values:          [[38], [49]]   
...

</code></pre><h3 id=existing-tables>Existing Tables</h3>
<p>Top K works the same way for ANALYZE commands as for INSERT commands.</p>
<h2 id=current-status-jira>Current Status (JIRA)</h2>
<p>See <a href=https://issues.apache.org/jira/browse/HIVE-3421>HIVE-3421</a>.</p>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are © 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>