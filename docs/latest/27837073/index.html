<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : Hive across Multiple Data Centers (Physical Clusters)</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu style=background:#000;margin:0>
<nav class="navbar navbar-expand-lg navbar-dark bg-black">
<div class=container-fluid>
<a href=https://hive.apache.org> <img src=https://hive.apache.org/images/hive.svg width=60 height=35 alt="Apache Software Foundation"></a>
<a class="header-text navbar-brand" href=https://hive.apache.org>Apache Hive</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item dropdown">
<a class=nav-link href=/general/downloads id=navbarDropdown role=button aria-expanded=false>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/LanguageManual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/DesignDocs>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HiveDeveloperFAQ>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Hive+PreCommit+Patch+Testing>Precommit Patch Testing</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToContribute>How To Contribute</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Home#Home-ResourcesforContributors>Resources for Contributors</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li>
<hr class=dropdown-divider>
</li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToRelease>How To Release</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class=nav-link href=https://hive.blog.apache.org/ id=navbarDropdown role=button aria-expanded=false>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
<li>
<form action=/search method=get class=search-bar>
<input type=search name=q id=search-query placeholder=Search... class=search-input>
<button type=submit class=search-button>Search</button>
</form>
</li>
</ul>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs>
<h1 id=apache-hive--hive-across-multiple-data-centers-physical-clusters>Apache Hive : Hive across Multiple Data Centers (Physical Clusters)</h1>
<p>This project has been abandoned. We&rsquo;re leaving the design doc here in case someone decides to attempt this project in the future.</p>
<ul>
<li><a href=#use-cases>Use Cases</a></li>
<li><a href=#requirements>Requirements</a></li>
</ul>
<h2 id=use-cases>Use Cases</h2>
<p>Inside facebook, we are running out of power inside a data center (physical cluster), and we have a need to have a bigger cluster.</p>
<p>We can divide the cluster into multiple clusters - multiple hive instances, multiple mr and multiple dfs. This will put a burden on</p>
<p>the user - he needs to know which cluster to use. It will be very difficult to support joins across tables in different clusters, and</p>
<p>will lead to a lot of duplication of data in the long run. To get around these problems, we are planning to extend hive to span</p>
<p>multiple data centers, and make the existence of multiple clusters transparent to the end users in the long run. Note that, even</p>
<p>today, different partitions/tables can span multiple dfs&rsquo;s, and hive does not enforce any restrictions. Those dfs&rsquo;s can be in different</p>
<p>data centers also. However, a single table/partition can only have a single location. We need to enhance this. We will not be able to</p>
<p>partition our warehouse cluster into multiple disjoint clusters, and therefore some tables/partitions will be present in multiple clusters.</p>
<h2 id=requirements>Requirements</h2>
<p>In order to do so, we need to make some changes in hive, and this document primarily talks about those. The changes should be generic</p>
<p>enough, so that they can be used by others (outside Facebook) also, if they have such a requirement. The following restrictions have</p>
<p>been imposed to simplify the problem:</p>
<ul>
<li>There will be a single hive instance, possibly spanning multiple clusters (both dfs and mr)</li>
<li>There will be a single hive metastore to keep track of the table/partition locations across different clusters.</li>
<li>A table/partition can exist in more than one cluster. A table will have a single primary cluster, and can have multiple</li>
</ul>
<p>secondary clusters.</p>
<ul>
<li>Table/Partition&rsquo;s metadata will be enhanced to support multiple clusters/locations of the table.</li>
<li>All the data for a table is available in the primary cluster, but a subset can be available in the secondary cluster.</li>
</ul>
<p>However, an object (unpartitioned table/partition) is either fully present or not present at all in the secondary cluster.</p>
<p>It is not possible to have partial data of a partition in the secondary cluster.</p>
<ul>
<li>
<p>The user can only update the table (or its partition) in the primary cluster.</p>
</li>
<li>
<p>The following mapping will be added. Cluster -> JobTracker</p>
</li>
<li>
<p>By default, the user will not specify any cluster for the session, and the behavior will be as follows:</p>
<ul>
<li>The query will be processed in a single cluster, and use the jobtracker for that cluster.</li>
<li>If the primary cluster of any output table is different from the query processing cluster, an error is thrown.</li>
</ul>
<p>So, a multi-table insert with tables belonging to different primary clusters will always fail.</p>
<ul>
<li>If the input&rsquo;s table primary cluster is different from the query processing cluster, the query will only succeed</li>
</ul>
<p>if all the partitions for that input table are also present on the query processing cluster.</p>
<ul>
<li>If an output is specified, the primary cluster for that output will be used.</li>
<li>If the output specified is a new table, the output is not used in determining the query processing cluster.</li>
<li>If no output is specified (or the output is a new table), and there are multiple inputs for the query, all the input tables</li>
</ul>
<p>primary clusters are tried one-by-one, till a valid cluster is found.</p>
</li>
<li>
<p>Few examples will illustrate the scenario better:</p>
</li>
<li>
<p>Say T11, T12, T21, T31 are tables belonging to cluster C1, C1, C2 and C3 respectively, and it has no secondary clusters.</p>
<ul>
<li>The query &lsquo;select .. from T11 .. ' will be processed in C1</li>
<li>The query &lsquo;select .. from T11 join T12 .. ' will be processed in C1</li>
<li>The query &lsquo;select .. from T21 .. ' will be processed in C2</li>
<li>The query &lsquo;select .. from T11 join T21 .. ' will fail</li>
<li>&lsquo;Insert .. T13 select .. from T11 ..&rsquo; will be processed in C1 and the T13 will be created in C1</li>
<li>&lsquo;Insert .. T21 select .. from T11 ..&rsquo; will fail</li>
</ul>
</li>
<li>
<p>If we change the example slightly:</p>
</li>
<li>
<p>Say T11, T12, T21, T31 are tables belonging to cluster C1, C1, C2 and C3 respectively.</p>
</li>
</ul>
<p>T11&rsquo;s secondary cluster is C2 (and all the data for T11 is also present in C2).
+ The query &lsquo;select .. from T11 .. ' will be processed in C1
+ The query &lsquo;select .. from T11 join T12 .. ' will be processed in C1
+ The query &lsquo;select .. from T21 .. ' will be processed in C2
+ The query &lsquo;select .. from T11 join T21 .. ' will be processed in C2
+ The query &lsquo;select .. from T11 join T31 .. ' will fail
+ &lsquo;Insert .. T13 select .. from T11 ..&rsquo; will be processed in C1 and the T13 will be created in C1
+ &lsquo;Insert .. T21 select .. from T11 ..&rsquo; will be processed in C2, and T21 will remain in C2</p>
<p>The same idea can be extended for partitioned tables.</p>
<ul>
<li>The user can also decide to run in a particular cluster.
<ul>
<li>Use cluster </li>
</ul>
</li>
<li>The system will not make an attempt to choose the cluster for the user, but only try to figure out if the query can be run</li>
</ul>
<p>in the . If the query can run in this cluster, it will succeed. Otherwise, it will fail.</p>
<ul>
<li>
<p>The user can go back to the behavior to use the default cluster.</p>
<ul>
<li>Use cluster</li>
</ul>
</li>
<li>
<p>Eventually, hive will provide some utilities to copy a table/partition from the primary cluster to the secondary clusters.</p>
</li>
</ul>
<p>In the first cut, the user needs to do this operation outside hive (one simple way to do so, is distcp the partition from the</p>
<p>primary to the secondary cluster, and then update the metadata directly - via the thrift api).</p>
<ul>
<li>This will require a change to the metastore schema. StorageDescriptor will be enhanced to add:</li>
</ul>
<p>PrimaryCluster - ClusterStorageDescriptor</p>
<p>and SecondaryClusters - Set</p>
<p>The ClusterStorageDescriptor contains the following:</p>
<p>ClusterName</p>
<p>Location</p>
<p>location will be removed from the StorageDescriptor.</p>
<ul>
<li>This will require a scheme change and data migration.</li>
<li>The thrift structure will be backward compatible
<ul>
<li>New entries will be added: ClusterName, IsPrimary etc., but existing clients using sd.location will continue to work</li>
</ul>
</li>
</ul>
<p>In order to support the above, hive metastore needs to be enhanced to have the concept of a cluster. The following parameters will</p>
<p>be added:</p>
<ul>
<li>hive.default.cluster.name - For migration, all tables/partitions belong to this cluster.</li>
</ul>
<p>All new tables belong to this cluster.</p>
<ul>
<li>hive.use.default.cluster - The default cluster will be used depending on input table&rsquo;s schema.</li>
</ul>
<p>The existing thrift API&rsquo;s will continue to work as if the user is trying to access the default cluster.</p>
<p>New APIs will be added which take the cluster as a new parameter. Almost all the existing APIs will be</p>
<p>enhanced to support this. The behavior will be the same as if, the user issued the command &lsquo;USE CLUSTER </p>
<ul>
<li>
<p>A new parameter will be added to keep the filesystem and jobtrackers for a cluster</p>
<ul>
<li>hive.cluster.properties: This will be json - ClusterName -> &lt;FileSystem, JobTracker></li>
<li>use cluster will fail if is not present hive.cluster.properties</li>
<li>The other option was to support create cluster &lt;> etc. but that would have required storing the cluster information in the</li>
</ul>
<p>metastore including jobtracker etc. which would be difficult to change per session.</p>
</li>
</ul>
<p>If the user does not intend of use multiple clusters, there should be no change in the behavior of hive commands, and all the</p>
<p>existing thrift APIs should continue to work.</p>
<p>An upgrade script will be provided to upgrade the metastore with the patch.</p>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are © 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>