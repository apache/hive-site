<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : Datasketches Integration</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu style=background:#000;margin:0>
<nav class="navbar navbar-expand-lg navbar-dark bg-black">
<div class=container-fluid>
<a href=https://hive.apache.org> <img src=https://hive.apache.org/images/hive.svg width=60 height=35 alt="Apache Software Foundation"></a>
<a class="header-text navbar-brand" href=https://hive.apache.org>Apache Hive</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item dropdown">
<a class=nav-link href=/general/downloads id=navbarDropdown role=button aria-expanded=false>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/LanguageManual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/DesignDocs>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HiveDeveloperFAQ>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Hive+PreCommit+Patch+Testing>Precommit Patch Testing</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToContribute>How To Contribute</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Home#Home-ResourcesforContributors>Resources for Contributors</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li>
<hr class=dropdown-divider>
</li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToRelease>How To Release</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class=nav-link href=https://hive.blog.apache.org/ id=navbarDropdown role=button aria-expanded=false>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
<li>
<form action=/search method=get class=search-bar>
<input type=search name=q id=search-query placeholder=Search... class=search-input>
<button type=submit class=search-button>Search</button>
</form>
</li>
</ul>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs>
<h1 id=apache-hive--datasketches-integration>Apache Hive : Datasketches Integration</h1>
<ul>
<li><a href=#sketch-functions>Sketch functions</a>
<ul>
<li><a href=#naming-convention>Naming convention</a></li>
<li><a href=#list-declared-sketch-functions>List declared sketch functions</a></li>
</ul>
</li>
<li><a href=#integration-with-materialized-views>Integration with materialized views</a></li>
<li><a href=#bi-mode>BI mode</a>
<ul>
<li><a href=#rewrite-countdistinctx>Rewrite COUNT(DISTINCT(X))</a></li>
<li><a href=#rewrite-percentile_discp-withing-grouporder-by-x>Rewrite percentile_disc(p) withing group(order by x)</a></li>
<li><a href=#rewrite-cume_dist---over--order-by-id->Rewrite cume_dist() over (order by id)</a></li>
<li><a href=#rewrite-ntile>Rewrite NTILE</a></li>
<li><a href=#rewrite-rank>Rewrite RANK</a></li>
</ul>
</li>
<li><a href=#examples>Examples</a>
<ul>
<li><a href=#simple-distinct-counting-examples-using-hll>Simple distinct counting examples using HLL</a></li>
</ul>
</li>
</ul>
<p>Apache DataSketches (<a href=https://datasketches.apache.org/>https://datasketches.apache.org/</a>) is integrated into Hive via <a href=https://issues.apache.org/jira/browse/HIVE-22939>HIVE-22939</a>.<br>
This enables various kind of sketch operations thru regular sql statement.</p>
<h1 id=sketch-functions>Sketch functions</h1>
<h2 id=naming-convention>Naming convention</h2>
<p>All sketch functions are registered using the following naming convention:</p>
<p><strong>ds_{sketchType}_{functionName}</strong></p>
<p>For example we have a function called: <strong>ds_hll_estimate</strong> which could be used to estimate the distinct values from an hll sketch.</p>
<h3 id=sketchtype>sketchType</h3>
<p>For detailed info about the sketches themself please refer to the datasketches site!</p>
<ul>
<li>frequency
<ul>
<li>hll</li>
<li>cpc</li>
<li>theta</li>
</ul>
</li>
<li>frequent items
<ul>
<li>freq</li>
</ul>
</li>
<li>histograms
<ul>
<li>kll</li>
</ul>
</li>
</ul>
<h3 id=functionname>functionName</h3>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>sketch</td>
<td>generates sketch data from input</td>
</tr>
<tr>
<td>estimate</td>
<td>computes the estimate for frequency related sketches</td>
</tr>
<tr>
<td>union</td>
<td>aggregate function to merge multiple sketches</td>
</tr>
<tr>
<td>union_f</td>
<td>unions 2 sketches given in the arguments</td>
</tr>
<tr>
<td>n</td>
<td>number of elements</td>
</tr>
<tr>
<td>cdf</td>
<td>cumulative distribution</td>
</tr>
<tr>
<td>rank</td>
<td>estimates the rank of the given element; returns a value in the range of 0~1</td>
</tr>
<tr>
<td>intersect</td>
<td>aggregate to intersect multiple sketches</td>
</tr>
<tr>
<td>intersect_f</td>
<td>intersect 2 sketches given in the arguments</td>
</tr>
<tr>
<td>stringify</td>
<td>returns the the sketch in a more readable form</td>
</tr>
</tbody>
</table>
<h2 id=list-declared-sketch-functions>List declared sketch functions</h2>
<p>Given that we have ~60 functions registered I would recommend to also consider listing/getting info about a single udf.</p>
<p>You could list all functions prefixed by ds_ using:</p>
<p><strong>show functions like &lsquo;ds_%';</strong></p>
<p>And you can access the description of a function like:</p>
<p><strong>desc function ds_freq_sketch;</strong></p>
<h1 id=integration-with-materialized-views>Integration with materialized views</h1>
<p>Sketch aggregation(s) are exposed to Calcite by some extensions - which could enable both the usage of an MV in a smaller dimension query; or could help in incremental updates.</p>
<h1 id=bi-mode>BI mode</h1>
<p>Usage of sketches can give a performance boost in case we could afford to loose some accuracy. Which could come very handy in case of charts or live dashboards.<br>
The BI mode is about making rewrites automatically to sketch functions if possible.</p>
<p>The BI mode can be enabled using:</p>
<pre tabindex=0><code>set hive.optimize.bi.enabled=true;
</code></pre><h2 id=rewrite-countdistinctx>Rewrite COUNT(DISTINCT(X))</h2>
<p>This feature can be toggled using the <strong>hive.optimize.bi.rewrite.countdistinct.enabled</strong> conf key</p>
<p>The used distinct sketch family can be configured using: <strong>hive.optimize.bi.rewrite.countdistinct.sketch</strong> (currently only hll is available).</p>
<p>This feature could rewrite</p>
<pre tabindex=0><code>select category, count(distinct id) from sketch_input group by category
</code></pre><p>to use a distinct count sketch to answer the query by rewriting it to</p>
<pre tabindex=0><code>select category, round(ds_hll_estimate(ds_hll_sketch(id))) from sketch_input
</code></pre><h2 id=rewrite-percentile_discp-withing-grouporder-by-x>Rewrite percentile_disc(p) withing group(order by x)</h2>
<p>This feature can be toggled using the<strong>hive.optimize.bi.rewrite.percentile_disc.enabled</strong> conf key</p>
<p>The used histogram sketch family can be configured using: <strong>hive.optimize.bi.rewrite.percentile_disc.sketch</strong> (currently only kll is available).</p>
<p>This feature could rewrite</p>
<pre tabindex=0><code>select percentile_disc(0.3) within group(order by id) from sketch_input
</code></pre><p>to use a histogram sketch to answer the query by rewriting to</p>
<pre tabindex=0><code>select ds_kll_quantile(ds_kll_sketch(id), 0.3) from sketch_input
</code></pre><h2 id=rewritecume_dist-over-order-by-id>Rewrite cume_dist() over (order by id)</h2>
<p>This feature can be toggled using the**<a href=http://hive.optimize.bi>hive.optimize.bi</a>.rewrite.cume_dist.enabled** conf key</p>
<p>The used histogram sketch family can be configured using: <a href=http://hive.optimize.bi>hive.optimize.bi</a>.rewrite.cume_dist.sketch (currently only kll is available).</p>
<pre tabindex=0><code>select id,cume_dist() over (order by id) from sketch_input
</code></pre><p>to use a histogram sketch to answer the query by rewriting to</p>
<pre tabindex=0><code>SELECT id, CAST(DS_KLL_RANK(t2.sketch, idVal) AS DOUBLE) 
FROM (SELECT id, CAST(COALESCE(CAST(id AS FLOAT), 340282346638528860000000000000000000000) AS FLOAT) AS idVal FROM sketch_input) AS t,
(SELECT DS_KLL_SKETCH(CAST(`id` AS FLOAT)) AS `sketch` FROM sketch_input) AS t2
</code></pre><h2 id=rewrite-ntile>Rewrite NTILE</h2>
<p>This feature can be toggled using the <strong><a href=http://hive.optimize.bi>hive.optimize.bi</a>.rewrite.ntile.enabled</strong> conf key</p>
<p>The used histogram sketch family can be configured using: <a href=http://hive.optimize.bi>hive.optimize.bi</a>.rewrite.ntile.sketch (currently only kll is available).</p>
<p>This feature can rewrite</p>
<pre tabindex=0><code>select id,
       ntile(4) over (order by id
from sketch_input
order by id
</code></pre><p>To use a histogram sketch to calculate the NTILE&rsquo;s value:</p>
<pre tabindex=0><code>select id,
        case when ceil(ds_kll_cdf(ds, CAST(id AS FLOAT) )[0]*4) &lt; 1 then 1 else ceil(ds_kll_cdf(ds, CAST(id AS FLOAT) )[0]*4) end
from sketch_input
join ( select ds_kll_sketch(cast(id as float)) as ds from sketch_input ) q
order by id

select id,
                rank() over (order by id),
                case when ds_kll_n(ds) &lt; (ceil(ds_kll_rank(ds, CAST(id AS FLOAT) )*ds_kll_n(ds))+1) then ds_kll_n(ds) else (ceil(ds_kll_rank(ds, CAST(id AS FLOAT) )*ds_kll_n(ds))+1) end

</code></pre><h2 id=rewrite-rank>Rewrite RANK</h2>
<p>This feature can be toggled using the <strong>hive.optimize.bi.rewrite.rank.enabled</strong> conf key</p>
<p>The used histogram sketch family can be configured using: <strong>hive.optimize.bi.rewrite.rank.sketch</strong> (currently only kll is available).</p>
<pre tabindex=0><code>select id,
       rank() over (order by id)
from sketch_input
order by id
</code></pre><p>is rewritten to</p>
<pre tabindex=0><code>select id,
       case when ds_kll_n(ds) &lt; (ceil(ds_kll_rank(ds, CAST(id AS FLOAT) )*ds_kll_n(ds))+1) then ds_kll_n(ds) else (ceil(ds_kll_rank(ds, CAST(id AS FLOAT) )*ds_kll_n(ds))+1) end
from sketch_input
join ( select ds_kll_sketch(cast(id as float)) as ds from sketch_input ) q
order by id
</code></pre><h1 id=examples>Examples</h1>
<h2 id=simple-distinct-counting-examples-using-hll>Simple distinct counting examples using HLL</h2>
<ul>
<li>Prepare sample table</li>
</ul>
<pre tabindex=0><code>create table sketch_input (id int, category char(1))
STORED AS ORC
TBLPROPERTIES ('transactional'='true');

insert into table sketch_input values
  (1,'a'),(1, 'a'), (2, 'a'), (3, 'a'), (4, 'a'), (5, 'a'), (6, 'a'), (7, 'a'), (8, 'a'), (9, 'a'), (10, 'a'),
  (6,'b'),(6, 'b'), (7, 'b'), (8, 'b'), (9, 'b'), (10, 'b'), (11, 'b'), (12, 'b'), (13, 'b'), (14, 'b'), (15, 'b')
; 
</code></pre><ul>
<li>
<h3 id=use-hll-to-compute-distinct-values-using-an-intermediate-table>Use HLL to compute distinct values using an intermediate table</h3>
</li>
</ul>
<pre tabindex=0><code>-- build sketches per category
create temporary table sketch_intermediate (category char(1), sketch binary);
insert into sketch_intermediate select category, ds_hll_sketch(id) from sketch_input group by category;

-- get unique count estimates per category
select category, ds_hll_estimate(sketch) from sketch_intermediate;

-- union sketches across categories and get overall unique count estimate
select ds_hll_estimate(ds_hll_union(sketch)) from sketch_intermediate;
</code></pre><ul>
<li>
<h3 id=use-hll-to-compute-distinct-values-without-intermediate-table>Use HLL to compute distinct values without intermediate table</h3>
</li>
</ul>
<pre tabindex=0><code>select category, ds_hll_estimate(ds_hll_sketch(id)) from sketch_input group by category;
select ds_hll_estimate(ds_hll_sketch(id)) from sketch_input;
</code></pre><ul>
<li>
<h3 id=use-hll-to-compute-distinct-values-transparently-thru-bi-mode>Use HLL to compute distinct values transparently thru BI mode</h3>
</li>
</ul>
<pre tabindex=0><code>set hive.optimize.bi.enabled=true;
select category,count(distinct id) from sketch_input group by category;
select count(distinct id) from sketch_input;
</code></pre><ul>
<li>
<h3 id=use-hll-to-compute-distinct-values-transparently-thru-bi-mode---while-utilizing-a-materialized-view-to-store-the-intermediate-sketches>Use HLL to compute distinct values transparently thru BI mode - while utilizing a Materialized View to store the intermediate sketches.</h3>
</li>
</ul>
<pre tabindex=0><code>-- create an MV to store precomputed HLL values
create  materialized view mv_1 as
  select category, ds_hll_sketch(id) from sketch_input group by category;

set hive.optimize.bi.enabled=true;
select category,count(distinct id) from sketch_input group by category;
select count(distinct id) from sketch_input;
</code></pre>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are © 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>