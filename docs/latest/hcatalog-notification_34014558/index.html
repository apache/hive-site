<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : HCatalog Notification</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu style=background:#000;margin:0>
<nav class="navbar navbar-expand-lg navbar-dark bg-black">
<div class=container-fluid>
<a href=https://hive.apache.org> <img src=https://hive.apache.org/images/hive.svg width=60 height=35 alt="Apache Software Foundation"></a>
<a class="header-text navbar-brand" href=https://hive.apache.org>Apache Hive</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item dropdown">
<a class=nav-link href=/general/downloads id=navbarDropdown role=button aria-expanded=false>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/LanguageManual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/DesignDocs>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HiveDeveloperFAQ>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Hive+PreCommit+Patch+Testing>Precommit Patch Testing</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToContribute>How To Contribute</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Home#Home-ResourcesforContributors>Resources for Contributors</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li>
<hr class=dropdown-divider>
</li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToRelease>How To Release</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class=nav-link href=https://hive.blog.apache.org/ id=navbarDropdown role=button aria-expanded=false>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
<li>
<form action=/search method=get class=search-bar>
<input type=search name=q id=search-query placeholder=Search... class=search-input>
<button type=submit class=search-button>Search</button>
</form>
</li>
</ul>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs>
<h1 id=apache-hive--hcatalog-notification>Apache Hive : HCatalog Notification</h1>
<h1 id=notification>Notification</h1>
<ul>
<li><a href=#notification>Notification</a>
<ul>
<li><a href=#notification-for-a-new-partition>Notification for a New Partition</a></li>
<li><a href=#notification-for-a-set-of-partitions>Notification for a Set of Partitions</a></li>
<li><a href=#server-configuration>Server Configuration</a>
<ul>
<li><a href=#enable-jms-notifications>Enable JMS Notifications</a></li>
<li><a href=#topic-names>Topic Names</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Since version 0.2, HCatalog provides notifications for certain events happening in the system. This way applications such as Oozie can wait for those events and schedule the work that depends on them. The current version of HCatalog supports two kinds of events:</p>
<ul>
<li>Notification when a new partition is added</li>
<li>Notification when a set of partitions is added</li>
</ul>
<p>No additional work is required to send a notification when a new partition is added: the existing <code>addPartition</code> call will send the notification message.</p>
<h2 id=notification-for-a-new-partition>Notification for a New Partition</h2>
<p>To receive notification that a new partition has been added, you need to follow these three steps.</p>
<ol>
<li>To start receiving messages, create a connection to a message bus as shown here:</li>
</ol>
<pre tabindex=0><code>ConnectionFactory connFac = new ActiveMQConnectionFactory(amqurl);
Connection conn = connFac.createConnection();
conn.start();

</code></pre><ol start=2>
<li>
<p>Subscribe to a topic you are interested in. When subscribing on a message bus, you need to subscribe to a particular topic to receive the messages that are being delivered on that topic.</p>
<ul>
<li>The topic name corresponding to a particular table is stored in table properties and can be retrieved using the following piece of code:</li>
</ul>
<pre tabindex=0><code>HiveMetaStoreClient msc = new HiveMetaStoreClient(hiveConf);
String topicName = msc.getTable(&quot;mydb&quot;,
                   &quot;myTbl&quot;).getParameters().get(HCatConstants.HCAT_MSGBUS_TOPIC_NAME);

</code></pre><p>``</p>
<ul>
<li>Use the topic name to subscribe to a topic as follows:</li>
</ul>
<pre tabindex=0><code>Session session = conn.createSession(true, Session.SESSION_TRANSACTED);
Destination hcatTopic = session.createTopic(topicName);
MessageConsumer consumer = session.createConsumer(hcatTopic);
consumer.setMessageListener(this);

</code></pre><p>``</p>
</li>
<li>
<p>To start receiving messages you need to implement the JMS interface <code>MessageListener</code>, which, in turn, will make you implement the method <code>onMessage(Message msg)</code>. This method will be called whenever a new message arrives on the message bus. The message contains a partition object representing the corresponding partition, which can be retrieved as shown here:</p>
</li>
</ol>
<pre tabindex=0><code>@Override
public void onMessage(Message msg) {
  // We are interested in only add_partition events on this table.
  // So, check message type first.
  if(msg.getStringProperty(HCatConstants.HCAT_EVENT).equals(HCatConstants.HCAT_ADD_PARTITION_EVENT)){
       Object obj = (((ObjectMessage)msg).getObject());
  }
}

</code></pre><p>You need to have a JMS jar in your classpath to make this work. Additionally, you need to have a JMS provider’s jar in your classpath. HCatalog is tested with ActiveMQ as a JMS provider, although any JMS provider can be used. ActiveMQ can be obtained from: <a href=http://activemq.apache.org/activemq-550-release.html>http://activemq.apache.org/activemq-550-release.html</a>.</p>
<h2 id=notification-for-a-set-of-partitions>Notification for a Set of Partitions</h2>
<p>Sometimes you need to wait until a collection of partitions is finished before proceeding with another operation. For example, you may want to start processing after all partitions for a day are done. However, HCatalog has no notion of collections or hierarchies of partitions. To support this, HCatalog allows data writers to signal when they are finished writing a collection of partitions. Data readers may wait for this signal before beginning to read.</p>
<p>The example code below illustrates how to send a notification when a set of partitions has been added.</p>
<p>To signal, a data writer does this:</p>
<pre tabindex=0><code>HiveMetaStoreClient msc = new HiveMetaStoreClient(conf);

// Create a map, specifying partition key names and values
Map&lt;String,String&gt; partMap = new HashMap&lt;String, String&gt;();
partMap.put(&quot;date&quot;,&quot;20110711&quot;);
partMap.put(&quot;country&quot;,&quot;*&quot;);

// Mark the partition as &quot;done&quot;
msc.markPartitionForEvent(&quot;mydb&quot;, &quot;mytbl&quot;, partMap, PartitionEventType.LOAD_DONE);

</code></pre><p>To receive this notification, the consumer needs to do the following:</p>
<ol>
<li>Repeat steps one and two from <a href=#above>above</a> to establish the connection to the notification system and to subscribe to the topic.</li>
<li>Receive the notification as shown in this example:</li>
</ol>
<pre tabindex=0><code>HiveMetaStoreClient msc = new HiveMetaStoreClient(conf);

// Create a map, specifying partition key names and values
Map&lt;String,String&gt; partMap = new HashMap&lt;String, String&gt;();
partMap.put(&quot;date&quot;,&quot;20110711&quot;);
partMap.put(&quot;country&quot;,&quot;*&quot;);

// Mark the partition as &quot;done&quot;
msc.markPartitionForEvent(&quot;mydb&quot;, &quot;mytbl&quot;, partMap, PartitionEventType.LOAD_DONE);

</code></pre><p>If the consumer has registered with the message bus and is currently live, it will get the callback from the message bus once the producer marks the partition as &ldquo;done&rdquo;. Alternatively, the consumer can ask explicitly for a particular partition from the metastore. The following code illustrates the usage from a consumer&rsquo;s perspective:</p>
<pre tabindex=0><code>// Enquire to metastore whether a particular partition has been marked or not.
boolean marked = msc.isPartitionMarkedForEvent(&quot;mydb&quot;, &quot;mytbl&quot;, partMap, PartitionEventType.LOAD_DONE);

// Or register to a message bus and get asynchronous callback.
ConnectionFactory connFac = new ActiveMQConnectionFactory(amqurl);
Connection conn = connFac.createConnection();
conn.start();
Session session = conn.createSession(true, Session.SESSION_TRANSACTED);
Destination hcatTopic = session.createTopic(topic);
MessageConsumer consumer = session.createConsumer(hcatTopic);
consumer.setMessageListener(this);

public void onMessage(Message msg) {

                                
  MapMessage mapMsg = (MapMessage)msg;
  Enumeration&lt;String&gt; keys = mapMsg.getMapNames();
  
  // Enumerate over all keys. This will print key-value pairs specifying the  
  // particular partition 44which was marked done. In this case, it will print:
  // date : 20110711
  // country: *

  while(keys.hasMoreElements()){
    String key = keys.nextElement();
    System.out.println(key + &quot; : &quot; + mapMsg.getString(key));
  }
  System.out.println(&quot;Message: &quot;+msg);

</code></pre><h2 id=server-configuration>Server Configuration</h2>
<p>To enable notification, you need to configure the server (see below).</p>
<p>To disable notification, you need to leave <code>hive.metastore.event.listeners</code> blank or remove it from <code>hive-site.xml</code>.</p>
<h3 id=enable-jms-notifications>Enable JMS Notifications</h3>
<p>You need to make (add/modify) the following changes to the <code>hive-site.xml</code> file of your HCatalog server to turn on notifications.</p>
<pre tabindex=0><code>&lt;property&gt;
&lt;name&gt;hive.metastore.event.expiry.duration&lt;/name&gt;
&lt;value&gt;300L&lt;/value&gt;
&lt;description&gt;Duration after which events expire from events table (in seconds)&lt;/description&gt;
&lt;/property&gt;

&lt;property&gt;
&lt;name&gt;hive.metastore.event.clean.freq&lt;/name&gt;
&lt;value&gt;360L&lt;/value&gt;
&lt;description&gt;Frequency at which timer task runs to purge expired events in metastore (in seconds).&lt;/description&gt;
&lt;/property&gt;

&lt;property&gt;
&lt;name&gt;msgbus.brokerurl&lt;/name&gt;
&lt;value&gt;tcp://localhost:61616&lt;/value&gt;
&lt;description&gt;&lt;/description&gt;
&lt;/property&gt;

&lt;property&gt;
&lt;name&gt;msgbus.username&lt;/name&gt;
&lt;value&gt;&lt;/value&gt;
&lt;description&gt;&lt;/description&gt;
&lt;/property&gt;

&lt;property&gt;
&lt;name&gt;msgbus.password&lt;/name&gt;
&lt;value&gt;&lt;/value&gt;
&lt;description&gt;&lt;/description&gt;
&lt;/property&gt;

</code></pre><p>For the server to start with support for notifications, the following must be in the classpath:</p>
<p>     (a) <code>activemq</code> jar</p>
<p>     (b) <code>jndi.properties</code> file with properties suitably configured for notifications</p>
<p>Then, follow these guidelines to set up your environment:</p>
<ol>
<li>The HCatalog server start script is <em>$YOUR_HCAT_SERVER</em><code>/share/hcatalog/scripts/hcat_server_start.sh</code>.</li>
<li>This script expects classpath to be set by the AUX_CLASSPATH environment variable.</li>
<li>Therefore set AUX_CLASSPATH to satisfy (a) and (b) above.</li>
<li>The <code>jndi.properties</code> file is located at <em>$YOUR_HCAT_SERVER</em><code>/etc/hcatalog/jndi.properties</code>.</li>
<li>You need to uncomment and set the following properties in the <code>jndi.properties</code> file:
<ul>
<li><code>java.naming.factory.initial = org.apache.activemq.jndi.ActiveMQInitialContextFactory</code></li>
<li><code>java.naming.provider.url = tcp://localhost:61616</code>    (This is the ActiveMQ URL in your setup.)</li>
</ul>
</li>
</ol>
<h3 id=topic-names>Topic Names</h3>
<p>If tables are created while the server is configured for notifications, a default topic name is automatically set as a table property. To use notifications with tables created previously (either in other HCatalog installations or prior to enabling notifications in the current installation) you will have to manually set a topic name. For example:</p>
<p>     <em>$YOUR_HCAT_CLIENT_HOME</em><code>/bin/hcat -e "ALTER TABLE access SET hcat.msgbus.topic.name=$TOPIC_NAME"</code></p>
<p>You then need to configure your ActiveMQ Consumer(s) to listen for messages on the topic you gave in $TOPIC_NAME. A good default policy is <code>TOPIC_NAME = "$database.$table"</code> (that is a literal dot).</p>
<p><strong>Navigation Links</strong>
Previous: <a href=https://hive.apache.org/docs/latest/hcatalog-dynamicpartitions_34014006/>Dynamic Partitioning</a><br>
Next: <a href=https://hive.apache.org/docs/latest/hcatalog-authorization_34014782/>Storage Based Authorization</a></p>
<p>General: <a href=https://hive.apache.org/docs/latest/hcatalog_33299065/>HCatalog Manual</a> – <a href=https://hive.apache.org/docs/latest/webhcat_33299069/>WebHCat Manual</a> – <a href=https://hive.apache.org/docs/latest/home_27362069/>Hive Wiki Home</a> – <a href=http://hive.apache.org/>Hive Project Site</a></p>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are © 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>