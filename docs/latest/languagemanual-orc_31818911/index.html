<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : LanguageManual ORC</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu style=background:#000;margin:0>
<nav class="navbar navbar-expand-lg navbar-dark bg-black">
<div class=container-fluid>
<a href=https://hive.apache.org> <img src=https://hive.apache.org/images/hive.svg width=60 height=35 alt="Apache Software Foundation"></a>
<a class="header-text navbar-brand" href=https://hive.apache.org>Apache Hive</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item dropdown">
<a class=nav-link href=/general/downloads id=navbarDropdown role=button aria-expanded=false>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/LanguageManual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/DesignDocs>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HiveDeveloperFAQ>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Hive+PreCommit+Patch+Testing>Precommit Patch Testing</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToContribute>How To Contribute</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Home#Home-ResourcesforContributors>Resources for Contributors</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li>
<hr class=dropdown-divider>
</li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToRelease>How To Release</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class=nav-link href=https://hive.blog.apache.org/ id=navbarDropdown role=button aria-expanded=false>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
<li>
<form action=/search method=get class=search-bar>
<input type=search name=q id=search-query placeholder=Search... class=search-input>
<button type=submit class=search-button>Search</button>
</form>
</li>
</ul>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs>
<h1 id=apache-hive--languagemanual-orc>Apache Hive : LanguageManual ORC</h1>
<h1 id=orc-files>ORC Files</h1>
<ul>
<li><a href=#orc-files>ORC Files</a>
<ul>
<li><a href=#orc-file-format>ORC File Format</a>
<ul>
<li><a href=#file-structure>File Structure</a></li>
<li><a href=#stripe-structure>Stripe Structure</a></li>
</ul>
</li>
<li><a href=#hiveql-syntax>HiveQL Syntax</a></li>
<li><a href=#serialization-and-compression>Serialization and Compression</a>
<ul>
<li><a href=#integer-column-serialization>Integer Column Serialization</a></li>
<li><a href=#string-column-serialization>String Column Serialization</a></li>
<li><a href=#compression>Compression</a></li>
</ul>
</li>
<li><a href=#orc-file-dump-utility>ORC File Dump Utility</a></li>
<li><a href=#orc-configuration-parameters>ORC Configuration Parameters</a></li>
</ul>
</li>
<li><a href=#orc-format-specification>ORC Format Specification</a></li>
</ul>
<h2 id=orc-file-format>ORC File Format</h2>
<p>Version</p>
<p>Introduced in Hive version <a href=https://issues.apache.org/jira/browse/HIVE-3874>0.11.0</a>.</p>
<p>The <em>Optimized Row Columnar</em> (<a href=https://orc.apache.org>ORC</a>) file format provides a highly efficient way to store Hive data. It was designed to overcome limitations of the other Hive file formats. Using ORC files improves performance when Hive is reading, writing, and processing data.</p>
<p>Compared with RCFile format, for example, ORC file format has many advantages such as:</p>
<ul>
<li>a single file as the output of each task, which reduces the NameNode&rsquo;s load</li>
<li>Hive type support including datetime, decimal, and the complex types (struct, list, map, and union)</li>
<li>light-weight indexes stored within the file
<ul>
<li>skip row groups that don&rsquo;t pass predicate filtering</li>
<li>seek to a given row</li>
</ul>
</li>
<li>block-mode compression based on data type
<ul>
<li>run-length encoding for integer columns</li>
<li>dictionary encoding for string columns</li>
</ul>
</li>
<li>concurrent reads of the same file using separate RecordReaders</li>
<li>ability to split files without scanning for markers</li>
<li>bound the amount of memory needed for reading or writing</li>
<li>metadata stored using Protocol Buffers, which allows addition and removal of fields</li>
</ul>
<h3 id=file-structure>File Structure</h3>
<p>An ORC file contains groups of row data called <strong>stripes</strong>, along with auxiliary information in a <strong>file footer</strong>. At the end of the file a <strong>postscript</strong> holds compression parameters and the size of the compressed footer.</p>
<p>The default stripe size is 250 MB. Large stripe sizes enable large, efficient reads from HDFS.</p>
<p>The file footer contains a list of stripes in the file, the number of rows per stripe, and each column&rsquo;s data type. It also contains column-level aggregates count, min, max, and sum.</p>
<p>This diagram illustrates the ORC file structure:</p>
<p><img src=/attachments/31818911/31948932.png alt></p>
<h3 id=stripe-structure>Stripe Structure</h3>
<p>As shown in the diagram, each stripe in an ORC file holds index data, row data, and a stripe footer.</p>
<p>The <strong>stripe footer</strong> contains a directory of stream locations. <strong>Row data</strong> is used in table scans.</p>
<p><strong>Index data</strong> includes min and max values for each column and the row positions within each column. (A bit field or bloom filter could also be included.) Row index entries provide offsets that enable seeking to the right compression block and byte within a decompressed block.  Note that ORC indexes are used only for the selection of stripes and row groups and not for answering queries.</p>
<p>Having relatively frequent row index entries enables row-skipping within a stripe for rapid reads, despite large stripe sizes. By default every 10,000 rows can be skipped.</p>
<p>With the ability to skip large sets of rows based on filter predicates, you can sort a table on its secondary keys to achieve a big reduction in execution time. For example, if the primary partition is transaction date, the table can be sorted on state, zip code, and last name. Then looking for records in one state will skip the records of all other states.</p>
<p>A complete specification of the format is given in the <a href=#orc-specification>ORC specification</a>.</p>
<h2 id=hiveql-syntax>HiveQL Syntax</h2>
<p>File formats are specified at the table (or partition) level. You can specify the ORC file format with HiveQL statements such as these:</p>
<ul>
<li><code>CREATE TABLE ... STORED AS ORC</code></li>
<li><code>ALTER TABLE ... [PARTITION partition_spec] SET FILEFORMAT ORC</code></li>
<li><code>SET hive.default.fileformat=Orc</code></li>
</ul>
<p>The parameters are all placed in the TBLPROPERTIES (see <a href=#create-table>Create Table</a>). They are:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>orc.compress</td>
<td>ZLIB</td>
<td>high level compression (one of NONE, ZLIB, SNAPPY)</td>
</tr>
<tr>
<td>orc.compress.size</td>
<td>262,144</td>
<td>number of bytes in each compression chunk</td>
</tr>
<tr>
<td>orc.stripe.size</td>
<td>67,108,864</td>
<td>number of bytes in each stripe</td>
</tr>
<tr>
<td>orc.row.index.stride</td>
<td>10,000</td>
<td>number of rows between index entries (must be >= 1000)</td>
</tr>
<tr>
<td>orc.create.index</td>
<td>true</td>
<td>whether to create row indexes</td>
</tr>
<tr>
<td>orc.bloom.filter.columns</td>
<td>""</td>
<td>comma separated list of column names for which bloom filter should be created</td>
</tr>
<tr>
<td>orc.bloom.filter.fpp</td>
<td>0.05</td>
<td>false positive probability for bloom filter (must >0.0 and &lt;1.0)</td>
</tr>
</tbody>
</table>
<p>For example, creating an ORC stored table without compression:</p>
<pre tabindex=0><code>create table Addresses (
  name string,
  street string,
  city string,
  state string,
  zip int
) stored as orc tblproperties (&quot;orc.compress&quot;=&quot;NONE&quot;);

</code></pre><p>Version 0.14.0+: CONCATENATE</p>
<p><code>[ALTER TABLE table_name [PARTITION partition_spec] CONCATENATE](#alter-table-table_name-[partition-partition_spec]-concatenate)</code> can be used to merge small ORC files into a larger file, starting in <a href=https://issues.apache.org/jira/browse/HIVE-7509>Hive 0.14.0</a>. The merge happens at the stripe level, which avoids decompressing and decoding the data.</p>
<h2 id=serialization-and-compression>Serialization and Compression</h2>
<p>The serialization of column data in an ORC file depends on whether the data type is integer or string.</p>
<h3 id=integer-column-serialization>Integer Column Serialization</h3>
<p>Integer columns are serialized in two streams.</p>
<ol>
<li><em>present</em> bit stream: is the value non-null?</li>
<li>data stream: a stream of integers</li>
</ol>
<p>Integer data is serialized in a way that takes advantage of the common distribution of numbers:</p>
<ul>
<li>Integers are encoded using a variable-width encoding that has fewer bytes for small integers.</li>
<li>Repeated values are run-length encoded.</li>
<li>Values that differ by a constant in the range (-128 to 127) are run-length encoded.</li>
</ul>
<p>The <em>variable-width encoding</em> is based on Google&rsquo;s protocol buffers and uses the high bit to represent whether this byte is not the last and the lower 7 bits to encode data. To encode negative numbers, a zigzag encoding is used where 0, -1, 1, -2, and 2 map into 0, 1, 2, 3, 4, and 5 respectively.</p>
<p>Each set of numbers is encoded this way:</p>
<ul>
<li>If the first byte (b0) is negative:
<ul>
<li>-b0 variable-length integers follow.</li>
</ul>
</li>
<li>If the first byte (b0) is positive:
<ul>
<li>it represents b0 + 3 repeated integers</li>
<li>the second byte (-128 to +127) is added between each repetition</li>
<li>1 variable-length integer.</li>
</ul>
</li>
</ul>
<p>In <em>run-length encoding,</em> the first byte specifies run length and whether the values are literals or duplicates. Duplicates can step by -128 to +128. Run-length encoding uses protobuf style variable-length integers.</p>
<h3 id=string-column-serialization>String Column Serialization</h3>
<p>Serialization of string columns uses a dictionary to form unique column values. The dictionary is sorted to speed up predicate filtering and improve compression ratios.</p>
<p>String columns are serialized in four streams.</p>
<ol>
<li><em>present</em> bit stream: is the value non-null?</li>
<li>dictionary data: the bytes for the strings</li>
<li>dictionary length: the length of each entry</li>
<li>row data: the row values</li>
</ol>
<p>Both the dictionary length and the row values are run-length encoded streams of integers.</p>
<h3 id=compression>Compression</h3>
<p>Streams are compressed using a codec, which is specified as a table property for all streams in that table. To optimize memory use, compression is done incrementally as each block is produced. Compressed blocks can be jumped over without first having to be decompressed for scanning. Positions in the stream are represented by a block start location and an offset into the block.</p>
<p>The codec can be Snappy, Zlib, or <em>none</em>.</p>
<h2 id=orc-file-dump-utility>ORC File Dump Utility</h2>
<p>The ORC file dump utility analyzes ORC files.  To invoke it, use this command:</p>
<pre tabindex=0><code>// Hive version 0.11 through 0.14:
hive --orcfiledump &lt;location-of-orc-file&gt;
 
// Hive version 1.1.0 and later:
hive --orcfiledump [-d] [--rowindex &lt;col_ids&gt;] &lt;location-of-orc-file&gt;
 
// Hive version 1.2.0 and later:
hive --orcfiledump [-d] [-t] [--rowindex &lt;col_ids&gt;] &lt;location-of-orc-file&gt;
 
// Hive version 1.3.0 and later:
hive --orcfiledump [-j] [-p] [-d] [-t] [--rowindex &lt;col_ids&gt;] [--recover] [--skip-dump] 
    [--backup-path &lt;new-path&gt;] &lt;location-of-orc-file-or-directory&gt;
</code></pre><p>Specifying <code>-d</code> in the command will cause it to dump the ORC file data rather than the metadata (Hive <a href=https://issues.apache.org/jira/browse/HIVE-7896>1.1.0</a> and later).</p>
<p>Specifying <code>--rowindex</code> with a comma separated list of column ids will cause it to print <a href=#row-indexes>row indexes</a> for the specified columns, where 0 is the top level struct containing all of the columns and 1 is the first column id (Hive <a href=https://issues.apache.org/jira/browse/HIVE-7896>1.1.0</a> and later).</p>
<p>Specifying <code>-t</code> in the command will print the timezone id of the writer.</p>
<p>Specifying <code>-j</code> in the command will print the ORC file metadata in JSON format. To pretty print the JSON metadata, add <code>-p</code> to the command.</p>
<p>Specifying <code>--recover</code> in the command will recover a corrupted ORC file generated by Hive streaming.</p>
<p>Specifying <code>--skip-dump</code> along with <code>--recover</code> will perform recovery without dumping metadata.</p>
<p>Specifying <code>--backup-path</code> with a <em>new-path</em> will let the recovery tool move corrupted files to the specified backup path (default: /tmp).</p>
<p><em></em> is the URI of the ORC file.</p>
<p><em></em> is the URI of the ORC file or directory. From <a href=https://issues.apache.org/jira/browse/HIVE-11669>Hive 1.3.0</a> onward, this URI can be a directory containing ORC files.</p>
<h2 id=orc-configuration-parameters>ORC Configuration Parameters</h2>
<p>The ORC configuration parameters are described in <a href=#hive-configuration-properties –-orc-file-format>Hive Configuration Properties – ORC File Format</a>.</p>
<h1 id=orc-format-specification>ORC Format Specification</h1>
<p>The ORC specification has moved to <a href=https://orc.apache.org/specification/>ORC project</a>.</p>
<h2 id=attachments>Attachments:</h2>
<p><img src=images/icons/bullet_blue.gif alt></p>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are © 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>