<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : StorageHandlers</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu style=background:#000;margin:0>
<nav class="navbar navbar-expand-lg navbar-dark bg-black">
<div class=container-fluid>
<a href=https://hive.apache.org> <img src=https://hive.apache.org/images/hive.svg width=60 height=35 alt="Apache Software Foundation"></a>
<a class="header-text navbar-brand" href=https://hive.apache.org>Apache Hive</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item dropdown">
<a class=nav-link href=/general/downloads id=navbarDropdown role=button aria-expanded=false>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/LanguageManual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/DesignDocs>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HiveDeveloperFAQ>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Hive+PreCommit+Patch+Testing>Precommit Patch Testing</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToContribute>How To Contribute</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/Home#Home-ResourcesforContributors>Resources for Contributors</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li>
<hr class=dropdown-divider>
</li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=https://cwiki.apache.org/confluence/display/Hive/HowToRelease>How To Release</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class=nav-link href=https://hive.blog.apache.org/ id=navbarDropdown role=button aria-expanded=false>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
<li>
<form action=/search method=get class=search-bar>
<input type=search name=q id=search-query placeholder=Search... class=search-input>
<button type=submit class=search-button>Search</button>
</form>
</li>
</ul>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs>
<h1 id=apache-hive--storagehandlers>Apache Hive : StorageHandlers</h1>
<h1 id=hive-storage-handlers>Hive Storage Handlers</h1>
<ul>
<li><a href=#hive-storage-handlers>Hive Storage Handlers</a>
<ul>
<li><a href=#introduction>Introduction</a></li>
<li><a href=#terminology>Terminology</a></li>
<li><a href=#ddl>DDL</a></li>
<li><a href=#storage-handler-interface>Storage Handler Interface</a></li>
<li><a href=#hivemetahook-interface>HiveMetaHook Interface</a></li>
<li><a href=#open-issues>Open Issues</a></li>
</ul>
</li>
</ul>
<h2 id=introduction>Introduction</h2>
<p>This page documents the storage handler support being added to Hive as part of work on <a href=https://hive.apache.org/docs/latest/hbaseintegration_27362089/>HBaseIntegration</a>. The motivation is to make it possible to allow Hive to access data stored and managed by other systems in a modular, extensible fashion.</p>
<p>Besides HBase, a storage handler implementation is also available for <a href=http://code.google.com/p/hypertable/wiki/HiveExtension>Hypertable</a>, and others are being developed for <a href=https://issues.apache.org/jira/browse/HIVE-1434>Cassandra</a>, <a href=https://blogs.msdn.microsoft.com/mostlytrue/2014/04/04/analyzing-azure-table-storage-data-with-hdinsight/>Azure Table</a>, <a href=https://cwiki.apache.org/confluence/display/Hive/JdbcStorageHandler>JDBC</a> (MySQL and others), <a href=https://github.com/yc-huang/Hive-mongo>MongoDB</a>, <a href=https://www.elastic.co/guide/en/elasticsearch/hadoop/current/hive.html>ElasticSearch</a>, <a href="https://phoenix.apache.org/hive_storage_handler.html?platform=hootsuite">Phoenix HBase</a>, <a href="https://issues.voltdb.com/browse/ENG-10736?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel">VoltDB</a> and <a href=https://github.com/balshor/gdata-storagehandler>Google Spreadsheets</a>.  A <a href=https://github.com/HiveKa/HiveKa>Kafka handler</a> demo is available.</p>
<p>Hive storage handler support builds on existing extensibility features in both Hadoop and Hive:</p>
<ul>
<li>input formats</li>
<li>output formats</li>
<li>serialization/deserialization libraries</li>
</ul>
<p>Besides bundling these together, a storage handler can also implement a new metadata hook interface, allowing Hive DDL to be used for managing object definitions in both the Hive metastore and the other system&rsquo;s catalog simultaneously and consistently.</p>
<h2 id=terminology>Terminology</h2>
<p>Before storage handlers, Hive already had a concept of <em>managed</em> vs <em>external</em> tables. A managed table is one for which the definition is primarily managed in Hive&rsquo;s metastore, and for whose data storage Hive is responsible. An external table is one whose definition is managed in some external catalog, and whose data Hive does not own (i.e. it will not be deleted when the table is dropped).</p>
<p>Storage handlers introduce a distinction between <em>native</em> and <em>non-native</em> tables. A native table is one which Hive knows how to manage and access without a storage handler; a non-native table is one which requires a storage handler.</p>
<p>These two distinctions (<em>managed vs. external</em> and <em>native vs non-native</em>) are orthogonal. Hence, there are four possibilities for base tables:</p>
<ul>
<li>managed native: what you get by default with CREATE TABLE</li>
<li>external native: what you get with CREATE EXTERNAL TABLE when no STORED BY clause is specified</li>
<li>managed non-native: what you get with CREATE TABLE when a STORED BY clause is specified; Hive stores the definition in its metastore, but does not create any files itself; instead, it calls the storage handler with a request to create a corresponding object structure</li>
<li>external non-native: what you get with CREATE EXTERNAL TABLE when a STORED BY clause is specified; Hive registers the definition in its metastore and calls the storage handler to check that it matches the primary definition in the other system</li>
</ul>
<p>Note that we avoid the term <em>file-based</em> in these definitions, since the form of storage used by the other system is irrelevant.</p>
<h2 id=ddl>DDL</h2>
<p>Storage handlers are associated with a table when it is created via the new STORED BY clause, an alternative to the existing ROW FORMAT and STORED AS clause:</p>
<pre tabindex=0><code>CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name
  [(col_name data_type [COMMENT col_comment], ...)]
  [COMMENT table_comment]
  [PARTITIONED BY (col_name data_type [col_comment], col_name data_type [COMMENT col_comment], ...)]
  [CLUSTERED BY (col_name, col_name, ...) [SORTED BY (col_name, ...)] INTO num_buckets BUCKETS]
  [
   [ROW FORMAT row_format] [STORED AS file_format]
   | STORED BY 'storage.handler.class.name' [WITH SERDEPROPERTIES (...)]
  ]
  [LOCATION hdfs_path]
  [AS select_statement]

</code></pre><p>When STORED BY is specified, then row_format (DELIMITED or SERDE) and STORED AS cannot be specified, however starting from <a href=https://cwiki.apache.org/confluence/display/Hive/Hive-Iceberg+Integration>Hive 4.0</a>, they can coexist to create the Iceberg table, this is the only exception. Optional SERDEPROPERTIES can be specified as part of the STORED BY clause and will be passed to the serde provided by the storage handler.</p>
<p>See <a href=#create-table>CREATE TABLE</a> and <a href=#row-format,-storage-format,-and-serde>Row Format, Storage Format, and SerDe</a> for more information.</p>
<p>Example:</p>
<pre tabindex=0><code>CREATE TABLE hbase_table_1(key int, value string) 
STORED BY 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'
WITH SERDEPROPERTIES (
&quot;hbase.columns.mapping&quot; = &quot;cf:string&quot;,
&quot;hbase.table.name&quot; = &quot;hbase_table_0&quot;
);

</code></pre><p>DROP TABLE works as usual, but ALTER TABLE is not yet supported for non-native tables.</p>
<h2 id=storage-handler-interface>Storage Handler Interface</h2>
<p>The Java interface which must be implemented by a storage handler is reproduced below; for details, see the Javadoc in the code:</p>
<pre tabindex=0><code>package org.apache.hadoop.hive.ql.metadata;

import java.util.Map;

import org.apache.hadoop.conf.Configurable;
import org.apache.hadoop.hive.metastore.HiveMetaHook;
import org.apache.hadoop.hive.ql.plan.TableDesc;
import org.apache.hadoop.hive.serde2.SerDe;
import org.apache.hadoop.mapred.InputFormat;
import org.apache.hadoop.mapred.OutputFormat;

public interface HiveStorageHandler extends Configurable {
  public Class&lt;? extends InputFormat&gt; getInputFormatClass();
  public Class&lt;? extends OutputFormat&gt; getOutputFormatClass();
  public Class&lt;? extends SerDe&gt; getSerDeClass();
  public HiveMetaHook getMetaHook();
  public void configureTableJobProperties(
    TableDesc tableDesc,
    Map&lt;String, String&gt; jobProperties);
}

</code></pre><p>The <code>HiveMetaHook</code> is optional, and described in the next section. If <code>getMetaHook</code> returns non-null, the returned object&rsquo;s methods will be invoked as part of metastore modification operations.</p>
<p>The <code>configureTableJobProperties</code> method is called as part of planning a job for execution by Hadoop. It is the responsibility of the storage handler to examine the table definition and set corresponding attributes on jobProperties. At execution time, only these jobProperties will be available to the input format, output format, and serde.</p>
<p>See also <a href=https://hive.apache.org/docs/latest/filterpushdowndev_27362092/>FilterPushdownDev</a> to learn how a storage handler can participate in filter evaluation (to avoid full-table scans).</p>
<h2 id=hivemetahook-interface>HiveMetaHook Interface</h2>
<p>The <code>HiveMetaHook</code> interface is reproduced below; for details, see the Javadoc in the code:</p>
<pre tabindex=0><code>package org.apache.hadoop.hive.metastore;

import org.apache.hadoop.hive.metastore.api.MetaException;
import org.apache.hadoop.hive.metastore.api.Partition;
import org.apache.hadoop.hive.metastore.api.Table;

public interface HiveMetaHook {
  public void preCreateTable(Table table)
    throws MetaException;
  public void rollbackCreateTable(Table table)
    throws MetaException;
  public void commitCreateTable(Table table)
    throws MetaException;
  public void preDropTable(Table table)
    throws MetaException;
  public void rollbackDropTable(Table table)
    throws MetaException;
  public void commitDropTable(Table table, boolean deleteData)
    throws MetaException;

</code></pre><p>Note that regardless of whether or not a remote Thrift metastore process is used in the Hive configuration, meta hook calls are always made from the Hive client JVM (never from the Thrift metastore server). This means that the jar containing the storage handler class needs to be available on the client, but not the thrift server.</p>
<p>Also note that there is no facility for two-phase commit in metadata transactions against the Hive metastore and the storage handler. As a result, there is a small window in which a crash during DDL can lead to the two systems getting out of sync.</p>
<h2 id=open-issues>Open Issues</h2>
<ul>
<li>The storage handler class name is currently saved to the metastore via table property <code>storage_handler</code>; this should probably be a first-class attribute on MStorageDescriptor instead</li>
<li>Names of helper classes such as input format and output format are saved into the metastore based on what the storage handler returns during CREATE TABLE; it would be better to leave these null in case they are changed later as part of a handler upgrade</li>
<li>A dummy location is currently set for a non-native table (the same as if it were a native table), even though no Hive files are created for it. We would prefer to store null, but first we need to fix the way data source information is passed to input formats (HIVE-1133)</li>
<li>Storage handlers are currently set only at the table level. We may want to allow them to be specified per partition, including support for a table spanning different storage handlers.</li>
<li>FileSinkOperator should probably be refactored, since non-native tables aren&rsquo;t accessed as files, meaning a lot of the logic is irrelevant for them</li>
<li>It may be a good idea to support temporary disablement of metastore hooks as part of manual catalog repair operations</li>
<li>The CREATE TABLE grammar isn&rsquo;t quite as strict as the one given above; some changes are needed in order to prevent STORED BY and row_format both being specified at once</li>
<li>CREATE TABLE AS SELECT is currently prohibited for creating a non-native table. It should be possible to support this, although it may not make sense for all storage handlers. For example, for HBase, it won&rsquo;t make sense until the storage handler is capable of automatically filling in column mappings.</li>
</ul>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are © 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>