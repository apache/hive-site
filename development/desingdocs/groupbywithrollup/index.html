<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : GroupByWithRollup</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu class=main-menu>
<nav class="navbar navbar-expand-lg navbar-dark">
<div class=container-fluid>
<div class=navbar-brand-wrapper>
<a href=https://hive.apache.org class=navbar-logo>
<img src=https://hive.apache.org/images/hive.svg width=50 height=30 alt="Apache Hive Logo">
</a>
<a class=navbar-brand href=https://hive.apache.org>Apache Hive</a>
</div>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto">
<li class=nav-item>
<a class=nav-link href=https://hive.apache.org/general/downloads>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=docsDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=docsDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/latest/language/languagemanual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=generalDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=generalDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
<li><a class=dropdown-item href=/general/poweredby/>Powered by</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=devDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=devDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/desingdocs/>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/resources/hivedeveloperfaq>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=communityDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=communityDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/resources/howtocontribute>How To Contribute</a></li>
<li><a class=dropdown-item href=/community/resources/>Resources</a></li>
<li><a class=dropdown-item href=/community/meetings/>Meetings</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li><hr class=dropdown-divider></li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=/community/resources/howtorelease/>How To Release</a></li>
</ul>
</li>
<li class=nav-item>
<a class=nav-link href=https://hive.blog.apache.org/>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=asfDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=asfDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
</ul>
<div class=navbar-search>
<form action=/search method=get class=search-form>
<div class=search-input-group>
<input type=search name=q id=search-query placeholder=Search... class=search-input aria-label=Search>
<button type=submit class=search-button aria-label="Submit search">
<i class="fas fa-search"></i>
</button>
</div>
</form>
</div>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs-container>
<main class="docs-main docs-main-full">
<article class=docs-content>
<nav class=docs-breadcrumb>
<ol>
<li><a href=/><i class="fas fa-home"></i> Home</a></li>
<li><a href=/docs/>Documentation</a></li>
<li class=active>Apache Hive : GroupByWithRollup</li>
</ol>
</nav>
<header class=docs-header>
<h1 class=docs-title>Apache Hive : GroupByWithRollup</h1>
<div class=docs-meta>
<span class=docs-date>
<i class="fas fa-calendar-alt"></i>
Last updated: December 12, 2024
</span>
</div>
</header>
<div class=docs-toc>
<h4><i class="fas fa-list"></i> Table of Contents</h4>
<nav id=TableOfContents>
<ul>
<li><a href=#apache-hive--group-by-with-rollup>Apache Hive : Group By With Rollup</a>
<ul>
<li><a href=#terminology>Terminology</a></li>
<li><a href=#design>Design</a>
<ul>
<li><a href=#map-aggr--no-skew>Map Aggr & No Skew:</a></li>
<li><a href=#map-aggr--skew>Map Aggr & Skew</a></li>
<li><a href=#no-map-aggr--no-skew--no-rollup>No Map Aggr & No Skew & No Rollup</a></li>
<li><a href=#no-map-aggr--no-skew--with-rollup>No Map Aggr & No Skew & With Rollup</a></li>
<li><a href=#no-map-aggr--skew--no-distinct-or-no-rollup>No Map Aggr & Skew & (No Distinct or No Rollup)</a></li>
<li><a href=#no-map-aggr--skew--distinct--rollup>No Map Aggr & Skew & Distinct & Rollup</a></li>
</ul>
</li>
<li><a href=#references>References</a></li>
</ul>
</li>
</ul>
</nav>
</div>
<div class=docs-article>
<h1 id=apache-hive--group-by-with-rollup>Apache Hive : Group By With Rollup</h1>
<aside class=table-of-contents>
<nav id=TableOfContents>
<ul>
<li><a href=#apache-hive--group-by-with-rollup>Apache Hive : Group By With Rollup</a>
<ul>
<li><a href=#terminology>Terminology</a></li>
<li><a href=#design>Design</a>
<ul>
<li><a href=#map-aggr--no-skew>Map Aggr & No Skew:</a></li>
<li><a href=#map-aggr--skew>Map Aggr & Skew</a></li>
<li><a href=#no-map-aggr--no-skew--no-rollup>No Map Aggr & No Skew & No Rollup</a></li>
<li><a href=#no-map-aggr--no-skew--with-rollup>No Map Aggr & No Skew & With Rollup</a></li>
<li><a href=#no-map-aggr--skew--no-distinct-or-no-rollup>No Map Aggr & Skew & (No Distinct or No Rollup)</a></li>
<li><a href=#no-map-aggr--skew--distinct--rollup>No Map Aggr & Skew & Distinct & Rollup</a></li>
</ul>
</li>
<li><a href=#references>References</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
<h2 id=terminology>Terminology</h2>
<ul>
<li>(No) Map Aggr: Shorthand for whether the configuration variable hive.map.aggr is set to true or false, meaning mapside aggregation is allowed or not respectively.</li>
<li>(No) Skew: Shorthand for whether the configuration variable hive.groupby.skewindata is set to true or false, meaning some columns have a disproportionate number of distinct values.</li>
</ul>
<h2 id=design>Design</h2>
<p>Before the rollup option was added to the group by operator, there were 4 different plans based on the 4 possible combinations of (No) Map Aggr and (No) Skew. These were built on and expanded to 6 plans as described below:</p>
<h3 id=map-aggr--no-skew>Map Aggr & No Skew:</h3>
<p>This plan remains the same, only the implementation of the map-side hash-based aggregation operator was modified to handle the extra rows needed for rollup. The plan is as follows:</p>
<p>Mapper:</p>
<p>*Hash-based group by operator to perform partial aggregations</p>
<p>*Reduce sink operator, performs some partial aggregations</p>
<p>Reducer:</p>
<p>*MergePartial (list-based) group by operator to perform final aggregations</p>
<h3 id=map-aggr--skew>Map Aggr & Skew</h3>
<p>Again, this plan remains the same, only the implementation of the map-side hash-based aggregation operator was modified to handle the extra rows needed for rollup. The plan is as follows:</p>
<p>Mapper 1:</p>
<p>*Hash-based group by operator to perform partial aggregations</p>
<p>*Reduce sink operator to spray by the group by and distinct keys (if there is a distinct key) or a random number otherwise</p>
<p>Reducer 1:</p>
<p>*Partials (list-based) group by operator to perform further partial aggregations</p>
<p>Mapper 2:</p>
<p>*Reduce sink operator, performs some partial aggregations</p>
<p>Reducer 2:</p>
<p>*Final (list-based) group by operator to perform final aggregations</p>
<p>Note that if there are no group by keys or distinct keys, Reducer 1 and Mapper 2 are removed from the plan and the reduce sink operator in Mapper 1 does not spray</p>
<h3 id=no-map-aggr--no-skew--no-rollup>No Map Aggr & No Skew & No Rollup</h3>
<p>This plan is the case from pre-rollup version of group by where there is no Map Aggr and No Skew, I included it for completeness as it remains an option if rollup is not used. The plan is as follows:</p>
<p>Mapper:</p>
<p>*Reduce sink operator, performs some partial aggregations</p>
<p>Reducer:</p>
<p>*Complete (list-based) group by operator to perform all aggregations</p>
<h3 id=no-map-aggr--no-skew--with-rollup>No Map Aggr & No Skew & With Rollup</h3>
<p>The plan is as follows:</p>
<p>Mapper 1:</p>
<p>*Reduce sink operator, does not perform any partial aggregations</p>
<p>Reducer 1:</p>
<p>*Hash-based group by operator, much like the one used in the mappers of previous cases</p>
<p>Mapper 2:</p>
<p>*Reduce sink operator, performs some partial aggregations</p>
<p>Reducer 2:</p>
<p>*MergePartial (list-based) group by operator to perform remaining aggregations</p>
<h3 id=no-map-aggr--skew--no-distinct-or-no-rollup>No Map Aggr & Skew & (No Distinct or No Rollup)</h3>
<p>This plan is the same as was used for the case of No Map Aggr and Skew in the pre-rollup version of group by, for this cads when rollup is not used, or none of the aggregations make use of a distinct key. The implementation of the list-based group by operator was modified to handle the extra rows required for rollup if rollup is being used. The plan is as follows:</p>
<p>Mapper 1:</p>
<p>*Reduce sink operator to spray by the group by and distinct keys (if there is a distinct key) or a random number otherwise</p>
<p>Reducer 1:</p>
<p>*Partial1 (list-based) group by operator to perform partial aggregations, it makes use of the new list-based group by operator implementation for rollup if necessary</p>
<p>Mapper 2:</p>
<p>*Reduce sink operator, performs some partial aggregations</p>
<p>Reducer 2:</p>
<p>*Final (list-based) group by operator to perform remaining aggregations</p>
<h3 id=no-map-aggr--skew--distinct--rollup>No Map Aggr & Skew & Distinct & Rollup</h3>
<p>This plan is used when there is No Map Aggr and Skew and there is an aggregation that involves a distinct key and rollup is being used. The plan is as follows:</p>
<p>Mapper 1:</p>
<p>*Reduce sink operator to spray by the group by and distinct keys (if there is a distinct key) or a random number otherwise</p>
<p>Reducer 1:</p>
<p>*Hash-based group by operator, much like the one used in the mappers of previous cases</p>
<p>Mapper 2:</p>
<p>*Reduce sink operator to spray by the group by and distinct keys (if there is a distinct key) or a random number otherwise</p>
<p>Reducer 2:</p>
<p>*Partials (list-based) group by operator to perform further partial aggregations</p>
<p>Mapper 3:</p>
<p>*Reduce sink operator, performs some partial aggregations</p>
<p>Reducer 3:</p>
<p>*Final (list-based) group by operator to perform final aggregations</p>
<p>Note that if there are no group by keys or distinct keys, Reducer 2 and Mapper 3 are removed from the plan and the reduce sink operator in Mapper 2 does not spray. Also, note that the reason for Mapper 2 spraying is that if the skew in the data existed in a column that is not immediately nulled by the rollup (e.g. if we the group by keys are columns g1, g2, g3 in that order, we are concerned with the case where the skew exists in column g1 or g2) the skew may continue to exist after the hash aggregation, so we spray.</p>
<h2 id=references>References</h2>
<ul>
<li><a href=https://issues.apache.org/jira/secure/attachment/12437909/dp_design.txt>Original design doc</a></li>
<li><a href=https://issues.apache.org/jira/browse/HIVE-2397>HIVE-2397</a></li>
</ul>
</div>
<footer class=docs-footer>
<div class=docs-feedback>
<h4><i class="fas fa-comment"></i> Feedback</h4>
<p>Was this page helpful? Let us know how we can improve.</p>
<div class=docs-feedback-buttons>
<button class="btn btn-feedback btn-positive">
<i class="fas fa-thumbs-up"></i> Yes
</button>
<button class="btn btn-feedback btn-negative">
<i class="fas fa-thumbs-down"></i> No
</button>
</div>
</div>
<div class=docs-edit>
<a href=https://github.com/apache/hive-site/edit/main/content/Development/desingdocs/groupbywithrollup.md class="btn btn-outline">
<i class="fab fa-github"></i> Edit this page on GitHub
</a>
</div>
</footer>
</article>
<aside class=docs-toc-sidebar>
<div class=docs-toc-sticky>
<h4><i class="fas fa-list"></i> On this page</h4>
<nav id=TableOfContents>
<ul>
<li><a href=#apache-hive--group-by-with-rollup>Apache Hive : Group By With Rollup</a>
<ul>
<li><a href=#terminology>Terminology</a></li>
<li><a href=#design>Design</a>
<ul>
<li><a href=#map-aggr--no-skew>Map Aggr & No Skew:</a></li>
<li><a href=#map-aggr--skew>Map Aggr & Skew</a></li>
<li><a href=#no-map-aggr--no-skew--no-rollup>No Map Aggr & No Skew & No Rollup</a></li>
<li><a href=#no-map-aggr--no-skew--with-rollup>No Map Aggr & No Skew & With Rollup</a></li>
<li><a href=#no-map-aggr--skew--no-distinct-or-no-rollup>No Map Aggr & Skew & (No Distinct or No Rollup)</a></li>
<li><a href=#no-map-aggr--skew--distinct--rollup>No Map Aggr & Skew & Distinct & Rollup</a></li>
</ul>
</li>
<li><a href=#references>References</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are Â© 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>