<!doctype html><html><!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=author content>
<title>Apache Hive : Locking</title>
<link rel=icon href=/images/hive.svg sizes=any type=image/svg+xml>
<link rel=stylesheet href=https://hive.apache.org/css/hive-theme.css>
<link rel=stylesheet href=https://hive.apache.org/css/font-awesome.all.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/bootstrap.min.css>
<link rel=stylesheet href=https://hive.apache.org/css/termynal.css>
<link rel=apple-touch-icon sizes=180x180 href=https://hive.apache.org/images/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://hive.apache.org/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://hive.apache.org/images/favicon-16x16.png>
<link rel=manifest href=https://hive.apache.org/images/site.webmanifest>
<link rel=mask-icon href=https://hive.apache.org/images/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<script>var _paq=window._paq=window._paq||[];_paq.push(['disableCookies']),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://analytics.apache.org/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','30']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script>
</head>
<body>
<body>
<header>
<menu class=main-menu>
<nav class="navbar navbar-expand-lg navbar-dark">
<div class=container-fluid>
<div class=navbar-brand-wrapper>
<a href=https://hive.apache.org class=navbar-logo>
<img src=https://hive.apache.org/images/hive.svg width=50 height=30 alt="Apache Hive Logo">
</a>
<a class=navbar-brand href=https://hive.apache.org>Apache Hive</a>
</div>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto">
<li class=nav-item>
<a class=nav-link href=https://hive.apache.org/general/downloads>
Releases
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/Document id=docsDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Documentation
</a>
<ul class=dropdown-menu aria-labelledby=docsDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/docs/latest/>Latest</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/javadocs/>Javadocs</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/docs/latest/language/languagemanual>Language Manual</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=/general id=generalDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
General
</a>
<ul class=dropdown-menu aria-labelledby=generalDropdown>
<li><a class=dropdown-item href=https://www.apache.org/licenses/LICENSE-2.0.html>License</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/general/privacypolicy/>Privacy Policy</a></li>
<li><a class=dropdown-item href=/general/poweredby/>Powered by</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=devDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Development
</a>
<ul class=dropdown-menu aria-labelledby=devDropdown>
<li><a class=dropdown-item href=https://hive.apache.org/development/gettingstarted/>Getting Started</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/quickstart/>Quickstart with Docker</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/desingdocs/>Design Docs</a></li>
<li><a class=dropdown-item href=https://issues.apache.org/jira/projects/HIVE/issues>Hive JIRA</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/resources/hivedeveloperfaq>Hive Developer FAQ</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/development/versioncontrol/>Version Control</a></li>
</ul>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=communityDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Community
</a>
<ul class=dropdown-menu aria-labelledby=communityDropdown>
<li><a class=dropdown-item href=/community/becomingcommitter/>Becoming A Committer</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/resources/howtocontribute>How To Contribute</a></li>
<li><a class=dropdown-item href=/community/resources/>Resources</a></li>
<li><a class=dropdown-item href=/community/meetings/>Meetings</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/mailinglists/>Mailing Lists</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/issuetracking/>Issue Tracking</a></li>
<li><a class=dropdown-item href=https://hive.apache.org/community/people/>People</a></li>
<li><hr class=dropdown-divider></li>
<li><a class=dropdown-item href=/community/bylaws/>By Laws</a></li>
<li><a class=dropdown-item href=/community/resources/howtorelease/>How To Release</a></li>
</ul>
</li>
<li class=nav-item>
<a class=nav-link href=https://hive.blog.apache.org/>
Blogs
</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=asfDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
ASF
</a>
<ul class=dropdown-menu aria-labelledby=asfDropdown>
<li><a class=dropdown-item href=https://www.apache.org/foundation/contributing.html>Donations</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a class=dropdown-item href=https://www.apache.org/foundation/thanks.html>Thanks</a></li>
<li><a class=dropdown-item href=https://www.apache.org/>Website</a></li>
</ul>
</li>
</ul>
<div class=navbar-search>
<form action=/search method=get class=search-form>
<div class=search-input-group>
<input type=search name=q id=search-query placeholder=Search... class=search-input aria-label=Search>
<button type=submit class=search-button aria-label="Submit search">
<i class="fas fa-search"></i>
</button>
</div>
</form>
</div>
</div>
</div>
</nav>
</menu>
</header>
<div class=content>
<div class=docs-container>
<main class="docs-main docs-main-full">
<article class=docs-content>
<nav class=docs-breadcrumb>
<ol>
<li><a href=/><i class="fas fa-home"></i> Home</a></li>
<li><a href=/docs/>Documentation</a></li>
<li class=active>Apache Hive : Locking</li>
</ol>
</nav>
<header class=docs-header>
<h1 class=docs-title>Apache Hive : Locking</h1>
<div class=docs-meta>
<span class=docs-date>
<i class="fas fa-calendar-alt"></i>
Last updated: December 12, 2024
</span>
</div>
</header>
<div class=docs-toc>
<h4><i class="fas fa-list"></i> Table of Contents</h4>
<nav id=TableOfContents>
<ul>
<li><a href=#apache-hive--locking>Apache Hive : Locking</a></li>
<li><a href=#hive-concurrency-model>Hive Concurrency Model</a>
<ul>
<li><a href=#use-cases>Use Cases</a></li>
<li><a href=#turn-off-concurrency>Turn Off Concurrency</a></li>
<li><a href=#debugging>Debugging</a></li>
<li><a href=#configuration>Configuration</a></li>
</ul>
</li>
<li><a href=#locking-in-hive-transactions>Locking in Hive Transactions</a></li>
</ul>
</nav>
</div>
<div class=docs-article>
<h1 id=apache-hive--locking>Apache Hive : Locking</h1>
<aside class=table-of-contents>
<nav id=TableOfContents>
<ul>
<li><a href=#apache-hive--locking>Apache Hive : Locking</a></li>
<li><a href=#hive-concurrency-model>Hive Concurrency Model</a>
<ul>
<li><a href=#use-cases>Use Cases</a></li>
<li><a href=#turn-off-concurrency>Turn Off Concurrency</a></li>
<li><a href=#debugging>Debugging</a></li>
<li><a href=#configuration>Configuration</a></li>
</ul>
</li>
<li><a href=#locking-in-hive-transactions>Locking in Hive Transactions</a></li>
</ul>
</nav>
</aside>
<h1 id=hive-concurrency-model>Hive Concurrency Model</h1>
<h2 id=use-cases>Use Cases</h2>
<p>Concurrency support (<a href=http://issues.apache.org/jira/browse/HIVE-1293>http://issues.apache.org/jira/browse/HIVE-1293</a>) is a must in databases and their use cases are well understood. At a minimum, we want to support concurrent readers and writers whenever possible. It would be useful to add a mechanism to discover the current locks which have been acquired. There is no immediate requirement to add an API to explicitly acquire any locks, so all locks would be acquired implicitly.</p>
<p>The following lock modes will be defined in hive (Note that Intent lock is not needed).</p>
<ul>
<li>Shared (S)</li>
<li>Exclusive (X)</li>
</ul>
<p>As the name suggests, multiple shared locks can be acquired at the same time, whereas X lock blocks all other locks.</p>
<p>The compatibility matrix is as follows:</p>
<p>| <strong>Lock</strong> <strong>Compatibility</strong>  | <strong>Existing Lock</strong> |
| <strong>S</strong>  | <strong>X</strong> |
| <strong>Requested</strong> <strong>Lock</strong> | <strong>S</strong> | <strong>True</strong> | <strong>False</strong> |
| <strong>X</strong> | <strong>False</strong> | <strong>False</strong> |</p>
<p>For some operations, locks are hierarchical in nature &ndash; for example for some partition operations, the table is also locked (to make sure that the table cannot be dropped while a new partition is being created).</p>
<p>The rational behind the lock mode to acquire is as follows:</p>
<p>For a non-partitioned table, the lock modes are pretty intuitive. When the table is being read, a S lock is acquired, whereas an X lock is acquired for all other operations (insert into the table, alter table of any kind etc.)</p>
<p>For a partitioned table, the idea is as follows:</p>
<p>A &lsquo;S&rsquo; lock on table and relevant partition is acquired when a read is being performed. For all other operations, an &lsquo;X&rsquo; lock is taken on the partition. However, if the change is only applicable to the newer partitions, a &lsquo;S&rsquo; lock is acquired on the table, whereas if the change is applicable to all partitions, a &lsquo;X&rsquo; lock is acquired on the table. Thus, older partitions can be read and written into, while the newer partitions are being converted to RCFile. Whenever a partition is being locked in any mode, all its parents are locked in &lsquo;S&rsquo; mode.</p>
<p>Based on this, the lock acquired for an operation is as follows:</p>
<table>
<thead>
<tr>
<th><strong>Hive Command</strong></th>
<th><strong>Locks Acquired</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>select .. T1 partition P1</strong></td>
<td><strong>S on T1, T1.P1</strong></td>
</tr>
<tr>
<td><strong>insert into T2(partition P2) select .. T1 partition P1</strong></td>
<td><strong>S on T2, T1, T1.P1 and X on T2.P2</strong></td>
</tr>
<tr>
<td><strong>insert into T2(partition P.Q) select .. T1 partition P1</strong></td>
<td><strong>S on T2, T2.P, T1, T1.P1 and X on T2.P.Q</strong></td>
</tr>
<tr>
<td><strong>alter table T1 rename T2</strong></td>
<td><strong>X on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 add cols</strong></td>
<td><strong>X on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 replace cols</strong></td>
<td><strong>X on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 change cols</strong></td>
<td><strong>X on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 <strong>concatenate</strong></strong></td>
<td><strong>X on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 add partition P1</strong></td>
<td><strong>S on T1, X on T1.P1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 drop partition P1</strong></td>
<td><strong>S on T1, X on T1.P1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 touch partition P1</strong></td>
<td><strong>S on T1, X on T1.P1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 set serdeproperties</strong></td>
<td><strong>S on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 set serializer</strong></td>
<td><strong>S on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 set file format</strong></td>
<td><strong>S on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 set tblproperties</strong></td>
<td><strong>X on T1</strong></td>
</tr>
<tr>
<td><strong>alter table T1 partition P1 concatenate</strong></td>
<td><strong>X on T1.P1</strong></td>
</tr>
<tr>
<td><strong>drop table T1</strong></td>
<td><strong>X on T1</strong></td>
</tr>
</tbody>
</table>
<p>In order to avoid deadlocks, a very simple scheme is proposed here. All the objects to be locked are sorted lexicographically, and the required mode lock is acquired. Note that in some cases, the list of objects may not be known &ndash; for example in case of dynamic partitions, the list of partitions being modified is not known at compile time &ndash; so, the list is generated conservatively. Since the number of partitions may not be known, an exclusive lock is supposed to be taken (but currently not due to <a href=https://issues.apache.org/jira/browse/HIVE-3509>HIVE-3509</a> bug) on the table, or the prefix that is known.</p>
<p>Two new configurable parameters will be added to decide the number of retries for the lock and the wait time between each retry. If the number of retries are really high, it can lead to a live lock. Look at ZooKeeper recipes (<a href=http://hadoop.apache.org/zookeeper/docs/r3.1.2/recipes.html#sc_recipes_Locks>http://hadoop.apache.org/zookeeper/docs/r3.1.2/recipes.html#sc_recipes_Locks</a>) to see how read/write locks can be implemented using the zookeeper apis. Note that instead of waiting, the lock request will be denied. The existing locks will be released, and all of them will be retried after the retry interval.</p>
<p>The recipe listed above will not work as specified, because of the hierarchical nature of locks.</p>
<p>The &lsquo;S&rsquo; lock for table T is specified as follows:</p>
<ul>
<li>Call create( ) to create a node with pathname &ldquo;/warehouse/T/read-&rdquo;. This is the lock node used later in the protocol. Make sure to set the sequence and ephemeral flag.</li>
<li>Call getChildren( ) on the lock node without setting the watch flag.</li>
<li>If there is a child with a pathname starting with &ldquo;write-&rdquo; and a lower sequence number than the one obtained, the lock cannot be acquired. Delete the node created in the first step and return.</li>
<li>Otherwise the lock is granted.</li>
</ul>
<p>The &lsquo;X&rsquo; lock for table T is specified as follows:</p>
<ul>
<li>Call create( ) to create a node with pathname &ldquo;/warehouse/T/write-&rdquo;. This is the lock node used later in the protocol. Make sure to set the sequence and ephemeral flag.</li>
<li>Call getChildren( ) on the lock node without setting the watch flag.</li>
<li>If there is a child with a pathname starting with &ldquo;read-&rdquo; or &ldquo;write-&rdquo; and a lower sequence number than the one obtained, the lock cannot be acquired. Delete the node created in the first step and return.</li>
<li>Otherwise the lock is granted.</li>
</ul>
<p>The proposed scheme starves the writers for readers. In case of long readers, it may lead to starvation for writers.</p>
<p>The default Hive behavior will not be changed, and concurrency will not be supported.</p>
<h2 id=turn-off-concurrency>Turn Off Concurrency</h2>
<p>You can turn off concurrency by setting the following variable to false: <a href=#hive-support-concurrency>hive.support.concurrency</a>.</p>
<h2 id=debugging>Debugging</h2>
<p>You can see the locks on a table by issuing the following command:</p>
<ul>
<li>SHOW LOCKS &lt;TABLE_NAME>;</li>
<li>SHOW LOCKS &lt;TABLE_NAME> EXTENDED;</li>
<li>SHOW LOCKS &lt;TABLE_NAME> PARTITION (&lt;PARTITION_DESC>);</li>
<li>SHOW LOCKS &lt;TABLE_NAME> PARTITION (&lt;PARTITION_DESC>) EXTENDED;</li>
</ul>
<p>See also <a href=#explain-locks>EXPLAIN LOCKS</a>.</p>
<h2 id=configuration>Configuration</h2>
<p>Configuration properties for Hive locking are described in <a href=#locking>Locking</a>.</p>
<h1 id=locking-in-hive-transactions>Locking in Hive Transactions</h1>
<p>Hive <a href=https://issues.apache.org/jira/browse/HIVE-5317>0.13.0</a> adds transactions with row-level ACID semantics, using a new lock manager. For more information, see:</p>
<ul>
<li><a href=https://hive.apache.org/docs/latest/user/hive-transactions/>ACID and Transactions in Hive</a></li>
<li><a href=#lock-manager>Lock Manager</a></li>
</ul>
</div>
<footer class=docs-footer>
<div class=docs-feedback>
<h4><i class="fas fa-comment"></i> Feedback</h4>
<p>Was this page helpful? Let us know how we can improve.</p>
<div class=docs-feedback-buttons>
<button class="btn btn-feedback btn-positive">
<i class="fas fa-thumbs-up"></i> Yes
</button>
<button class="btn btn-feedback btn-negative">
<i class="fas fa-thumbs-down"></i> No
</button>
</div>
</div>
<div class=docs-edit>
<a href=https://github.com/apache/hive-site/edit/main/content/Development/desingdocs/locking.md class="btn btn-outline">
<i class="fab fa-github"></i> Edit this page on GitHub
</a>
</div>
</footer>
</article>
<aside class=docs-toc-sidebar>
<div class=docs-toc-sticky>
<h4><i class="fas fa-list"></i> On this page</h4>
<nav id=TableOfContents>
<ul>
<li><a href=#apache-hive--locking>Apache Hive : Locking</a></li>
<li><a href=#hive-concurrency-model>Hive Concurrency Model</a>
<ul>
<li><a href=#use-cases>Use Cases</a></li>
<li><a href=#turn-off-concurrency>Turn Off Concurrency</a></li>
<li><a href=#debugging>Debugging</a></li>
<li><a href=#configuration>Configuration</a></li>
</ul>
</li>
<li><a href=#locking-in-hive-transactions>Locking in Hive Transactions</a></li>
</ul>
</nav>
</div>
</aside>
</main>
</div>
</div>
<footer class="black-background static-bottom" style=padding:30px>
<div class=row>
<div class=col-3>
<a href=https://www.apache.org/>
<img src=https://hive.apache.org/images/asf_logo.png width=270 height=100 alt="Apache Software Foundation"></a>
</a>
</div>
<div class=col-9>
<p class=footer-text>Apache is a non-profit organization helping open-source
software projects released under the Apache
<a href=https://www.apache.org/licenses/>license</a>
and managed with
<a href=https://www.apache.org/foundation/how-it-works.html>
open governance</a> and
<a href=https://privacy.apache.org/policies/privacy-policy-public.html>
privacy policy</a>. See upcoming
<a href=https://www.apache.org/events/current-event>Apache Events</a>.
If you discover any
<a href=https://www.apache.org/security/>security</a> vulnerabilities, please
report them privately. Finally,
<a href=https://www.apache.org/foundation/sponsorship.html>thanks
</a> to the sponsors who
<a href=https://www.apache.org/foundation/contributing.html>
donate</a> to the Apache Foundation.
</p>
</div>
</div>
<div class="copyright row">
<a href=https://hive.apache.org style=color:grey>
The contents of this website are © 2023 Apache Software Foundation under the terms of the Apache License v2. Apache Hive and its logo are trademarks of the Apache Software Foundation.
</a>
</div>
</footer>
<script src=https://hive.apache.org/js/bootstrap.bundle.min.js></script>
</body>
</html>